<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2.6.2.2 Carousel Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,700;1,400;1,700&family=Roboto:ital,wght@0,400;0,700;1,400;1,700&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Oswald:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400;1,700&family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- html2canvas обязательно подключаем ДО нашего кода -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <div class="container">
        <div class="header">
            <h1>Карусельник 2.6.2.2</h1>
            <div style="display: flex; gap: 8px;">
                <button class="btn-delete" onclick="confirmDeleteSlide()">&#128465; Удалить</button>
                <button class="btn-download" onclick="toggleDownloadMenu()">⬇️ Скачать</button>
                <button class="btn-add" onclick="addSlide()">+ Добавить</button>
            </div>
            
            <!-- Выпадающее меню загрузки -->
            <div class="download-menu" id="downloadMenu">
                <button class="download-menu-item" onclick="openGallery()">
                    &#128444;&#65039; Галерея предпросмотра
                </button>
                <button class="download-menu-item" onclick="downloadCurrentSlide()">
                    ⬇️ Скачать этот слайд
                </button>
                <button class="download-menu-item" onclick="downloadAllSlides()">
                    ⬇️ Скачать все слайды
                </button>
            </div>
        </div>

        <div class="slide-preview">
            <button class="nav-arrow left" id="prevSlide" onclick="previousSlide()">←</button>
            <div class="slide-canvas ratio-4-5" id="slideCanvas">
                <div class="slide-background" id="slideBackground"></div>
                <div class="slide-pattern" id="slidePattern"></div>
                <div class="slide-overlay" id="slideOverlay"></div>
                <div class="slide-content">
                    <div class="slide-title" id="slideTitle"></div>
                    <div class="slide-text" id="slideText"></div>
                </div>
            </div>
            <button class="nav-arrow right" id="nextSlide" onclick="nextSlide()">→</button>
        </div>

        <div class="slide-navigation">
            <div class="slide-nav-scroll" id="slideNavigation">
                <button class="slide-btn active">1</button>
            </div>
        </div>

        <div class="bottom-menu">
            <button class="menu-btn" onclick="openModal('template')">
                <div class="menu-icon">&#129649;</div>
                <div>Шаблон</div>
            </button>
            <button class="menu-btn" onclick="openModal('background')">
                <div class="menu-icon">&#128444;&#65039;️️️</div>
                <div>Фон</div>
            </button>
            <button class="menu-btn" onclick="openModal('text')">
                <div class="menu-icon">✍️</div>
                <div>Текст</div>
            </button>
            <button class="menu-btn" onclick="openModal('format')">
                <div class="menu-icon">&#128208;</div>
                <div>Формат</div>
            </button>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Выбор шаблона</h3>
                <button class="close-btn" onclick="closeModal('template')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-grid" id="templateGrid"></div>
            </div>
            <div class="modal-footer">
                <label class="switch">
                    <input type="checkbox" id="applyToAll" />
                    <span class="slider" aria-hidden="true"></span>
                    <span class="switch-text">Применить ко всем слайдам</span>
                </label>
                <button class="save-btn" onclick="applyTemplate()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Background Modal -->
    <div class="modal" id="backgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Выбор фона</h3>
                <button class="close-btn" onclick="closeModal('background')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="section-title">ЦВЕТ ФОНА</div>
                <div class="color-grid" id="colorGrid"></div>
                
                <div class="upload-section">
                    <div class="section-title">ИЛИ ЗАГРУЗИТЬ ФОТО</div>
                    <label class="upload-btn">
                        <input type="file" accept="image/*" onchange="handleImageUpload(event)" style="display: none">
                        &#128444;&#65039; &#11014;&#65039; Загрузить изображение
                    </label>
                </div>

                <div class="pattern-section">
                    <div class="toggle-section">
                        <div class="toggle-header" onclick="togglePatternSection()">
                            <span style="font-weight: 600;">Добавить узор</span>
                            <div class="pattern-controls">
                                <button class="remove-pattern-btn" id="removePatternBtn" onclick="event.stopPropagation(); removePattern()">Убрать узор</button>
                                <span class="toggle-arrow" id="toggleArrow">▼</span>
                            </div>
                        </div>
                        <div class="advanced-settings" id="patternSettings">
                            <div class="section-title">ВЫБОР УЗОРА</div>
                            <div class="pattern-grid" id="patternGrid">
    <div class="pattern-option" onclick="selectPattern(0)">
        <div class="pattern-preview" 
             style="background-image: radial-gradient(circle, currentColor 1px, transparent 1px); 
                    color: #000; 
                    /* ДОБАВЛЕНО */
                    background-size: 10px 10px;"></div>
    </div>
    
    <div class="pattern-option" onclick="selectPattern(1)">
        <div class="pattern-preview" 
             style="background-image: repeating-linear-gradient(0deg, currentColor 0px, currentColor 1px, transparent 1px, transparent); 
                    color: #000; 
                    /* ДОБАВЛЕНО */
                    background-size: 100% 2px;"></div>
    </div>
    
    <div class="pattern-option" onclick="selectPattern(2)">
        <div class="pattern-preview" 
             style="background-image: linear-gradient(currentColor 1px, transparent 1px), linear-gradient(90deg, currentColor 1px, transparent 1px); 
                    color: #000; 
                    /* ДОБАВЛЕНО */
                    background-size: 10px 10px;"></div>
    </div>
    
    <div class="pattern-option" onclick="selectPattern(3)">
        <div class="pattern-preview" 
             style="background-image: repeating-linear-gradient(90deg, currentColor 0px, currentColor 2px, transparent 2px, transparent); 
                    color: #000; 
                    /* ДОБАВЛЕНО */
                    background-size: 4px 100%;"></div>
    </div>
</div>
                            
                            <div class="advanced-settings-toggle">
                                <div class="advanced-settings-header" onclick="toggleAdvancedSettings()">
                                    <span style="font-weight: 600; font-size: 14px;">Больше настроек</span>
                                    <span class="advanced-arrow" id="advancedArrow">▼</span>
                                </div>
                                <div class="advanced-settings-content" id="advancedSettingsContent">
                                    <div class="slider-group">
                                        <label>Прозрачность: <span id="opacityValue">30%</span></label>
                                        <input type="range" class="slider" min="0" max="100" value="30" 
                                               oninput="updatePatternOpacity(this.value)">
                                    </div>
                                    
                                    <div class="slider-group">
                                        <label>Масштаб: <span id="scaleValue">20px</span></label>
                                        <input type="range" class="slider" min="10" max="125" value="66" 
                                               oninput="updatePatternScale(this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- НОВАЯ СЕКЦИЯ: ПОДЛОЖКА -->
                <div class="overlay-section">
                    <div class="toggle-section">
                        <div class="toggle-header" onclick="toggleOverlaySection()">
                            <span style="font-weight: 600;">Добавить подложку</span>
                            <div class="overlay-controls">
                                <button class="remove-overlay-btn" id="removeOverlayBtn" onclick="event.stopPropagation(); removeOverlay()">Убрать подложку</button>
                                <span class="toggle-arrow" id="overlayToggleArrow">▼</span>
                            </div>
                        </div>
                        <div class="advanced-settings" id="overlaySettings">
                            <div class="color-picker-wrapper">
                                <label for="overlayColorPicker">Цвет подложки</label>
                                <input 
                                    type="color" 
                                    class="color-picker" 
                                    id="overlayColorPicker"
                                    value="#000000"
                                    onchange="updateOverlayColor(this.value)">
                            </div>

                            <div class="slider-group">
                                <label>Прозрачность: <span id="overlayOpacityValue">80%</span></label>
                                <input 
                                    type="range" 
                                    class="slider" 
                                    min="0" 
                                    max="100" 
                                    value="80" 
                                    id="overlayOpacitySlider"
                                    oninput="updateOverlayOpacity(this.value)">
                            </div>

                            <div class="slider-group">
                                <label>Высота от низа: <span id="overlayHeightValue">60%</span></label>
                                <input 
                                    type="range" 
                                    class="slider" 
                                    min="0" 
                                    max="100" 
                                    value="60" 
                                    id="overlayHeightSlider"
                                    oninput="updateOverlayHeight(this.value)">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- КОНЕЦ НОВОЙ СЕКЦИИ -->

            </div>
            <div class="modal-footer">
                <label class="switch">
                    <input type="checkbox" id="applyBgToAll" />
                    <span class="slider" aria-hidden="true"></span>
                    <span class="switch-text">Применить ко всем слайдам</span>
                </label>
                <button class="save-btn" onclick="applyBackground()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Text Modal -->
    <div class="modal" id="textModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Редактирование текста</h3>
                <button class="close-btn" onclick="closeModal('text')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-input-group">
                    <label>Текст слайда</label>
                    <textarea 
                        id="unifiedTextInput" 
                        placeholder="Введите текст. Первая строка станет заголовком..."
                        rows="6"
                        oninput="autoResizeTextarea(this); handleUnifiedTextInput()"></textarea>
                    <div style="font-size: 12px; color: #8e8e8e; margin-top: 6px;">
                        &#129668; Текст до первого переноса строки станет заголовком (макс. 100 символов)
                    </div>
                </div>

                <div class="checkbox-group" style="margin-top: 12px; margin-bottom: 0;">
                    <input type="checkbox" id="noTitleCheckbox" onchange="toggleNoTitle(this.checked)">
                    <label for="noTitleCheckbox">Слайд без заголовка (весь текст основной)</label>
                </div>

                <button class="accordion-button" id="titleSettingsBtn">
                    <span>Настройки заголовка</span>
                    <span class="arrow">▼</span>
                </button>
                <div class="accordion-content" id="titleSettingsContent">
                    <div class="font-settings">
                        <label class="slider-label">Шрифт</label>
                        <select class="font-select" id="titleFont" onchange="updateTitleFont(this.value)">
                            <option value="Montserrat">Montserrat</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Playfair Display">Playfair Display</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Lato">Lato</option>
                            <option value="PT Sans">PT Sans</option>
                        </select>

                        <div class="slider-group">
                            <label>Размер: <span id="titleSizeValue">32px</span></label>
                            <input 
                                type="range" 
                                class="slider" 
                                id="titleSizeSlider"
                                min="20" 
                                max="280" 
                                value="32"
                                oninput="updateTitleSize(this.value)">
                        </div>

                        <label class="slider-label">Начертание</label>
                        <div class="style-buttons">
                            <button class="style-btn" id="titleBoldBtn" onclick="toggleTitleBold()">
                                &#127345;&#65039;️️️ Жирный
                            </button>
                            <button class="style-btn" id="titleItalicBtn" onclick="toggleTitleItalic()">
                                &#128171; Наклон
                            </button>
                        </div>
                        
                        <label class="slider-label">Цвет</label>
                        <div class="color-grid" id="titleColorGrid">
                            <div class="color-option selected" style="background: #FFFFFF" onclick="selectColorTitle('#FFFFFF')"></div>
                            <div class="color-option" style="background: #000000" onclick="selectColorTitle('#000000')"></div>
                            <div class="color-option" style="background: #0095F6" onclick="selectColorTitle('#0095F6')"></div>
                            <div class="color-option" style="background: #FF6B6B" onclick="selectColorTitle('#FF6B6B')"></div>
                            <div class="color-option" style="background: #4ECDC4" onclick="selectColorTitle('#4ECDC4')"></div>
                            <div class="color-option" style="background: #FFD93D" onclick="selectColorTitle('#FFD93D')"></div>
                            <div class="color-option" style="background: #6BCF7F" onclick="selectColorTitle('#6BCF7F')"></div>
                            <div class="color-option" style="background: #A78BFA" onclick="selectColorTitle('#A78BFA')"></div>
                            <div class="color-option" style="background: #FB923C" onclick="selectColorTitle('#FB923C')"></div>
                            <div class="color-option" style="background: #EC4899" onclick="selectColorTitle('#EC4899')"></div>
                            <div class="color-option" style="background: #14B8A6" onclick="selectColorTitle('#14B8A6')"></div>
                            <div class="color-option" style="background: #8B5CF6" onclick="selectColorTitle('#8B5CF6')"></div>
                            <div class="color-option" style="background: #F59E0B" onclick="selectColorTitle('#F59E0B')"></div>
                            <div class="color-option" style="background: #10B981" onclick="selectColorTitle('#10B981')"></div>
                            <div class="color-option" style="background: #EF4444" onclick="selectColorTitle('#EF4444')"></div>
                        </div>
                    </div>
                </div>

                <button class="accordion-button" id="textSettingsBtn">
                    <span>Настройки текста</span>
                    <span class="arrow">▼</span>
                </button>
                <div class="accordion-content" id="textSettingsContent">
                    <div class="font-settings">
                        <label class="slider-label">Шрифт</label>
                        <select class="font-select" id="textFont" onchange="updateTextFont(this.value)">
                            <option value="Montserrat">Montserrat</option>
                            <option value="Roboto" selected>Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Playfair Display">Playfair Display</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Lato">Lato</option>
                            <option value="PT Sans">PT Sans</option>
                        </select>

                        <div class="slider-group">
                            <label>Размер: <span id="textSizeValue">16px</span></label>
                            <input 
                                type="range" 
                                class="slider" 
                                id="textSizeSlider"
                                min="12" 
                                max="150" 
                                value="16"
                                oninput="updateTextSize(this.value)">
                        </div>

                        <label class="slider-label">Начертание</label>
                        <div class="style-buttons">
                            <button class="style-btn" id="textBoldBtn" onclick="toggleTextBold()">
                                &#127345;&#65039;️️️ Жирный
                            </button>
                            <button class="style-btn" id="textItalicBtn" onclick="toggleTextItalic()">
                                &#128171; Наклон
                            </button>
                        </div>
                        
                        <label class="slider-label">Цвет</label>
                        <div class="color-grid" id="textColorGrid">
                            <div class="color-option selected" style="background: #FFFFFF" onclick="selectColorText('#FFFFFF')"></div>
                            <div class="color-option" style="background: #000000" onclick="selectColorText('#000000')"></div>
                            <div class="color-option" style="background: #0095F6" onclick="selectColorText('#0095F6')"></div>
                            <div class="color-option" style="background: #FF6B6B" onclick="selectColorText('#FF6B6B')"></div>
                            <div class="color-option" style="background: #4ECDC4" onclick="selectColorText('#4ECDC4')"></div>
                            <div class="color-option" style="background: #FFD93D" onclick="selectColorText('#FFD93D')"></div>
                            <div class="color-option" style="background: #6BCF7F" onclick="selectColorText('#6BCF7F')"></div>
                            <div class="color-option" style="background: #A78BFA" onclick="selectColorText('#A78BFA')"></div>
                            <div class="color-option" style="background: #FB923C" onclick="selectColorText('#FB923C')"></div>
                            <div class="color-option" style="background: #EC4899" onclick="selectColorText('#EC4899')"></div>
                            <div class="color-option" style="background: #14B8A6" onclick="selectColorText('#14B8A6')"></div>
                            <div class="color-option" style="background: #8B5CF6" onclick="selectColorText('#8B5CF6')"></div>
                            <div class="color-option" style="background: #F59E0B" onclick="selectColorText('#F59E0B')"></div>
                            <div class="color-option" style="background: #10B981" onclick="selectColorText('#10B981')"></div>
                            <div class="color-option" style="background: #EF4444" onclick="selectColorText('#EF4444')"></div>
                        </div>
                    </div>
                </div>

                <!-- Вертикальное выравнивание (всегда видно) -->
                <div class="alignment-section" style="margin-top: 24px;">
                    <label class="slider-label">Позиция на слайде (вертикаль)</label>
                    <div class="alignment-buttons-row">
                        <button class="alignment-btn" data-target="vertical" data-value="top" onclick="selectVerticalAlignment('top')">⬆️ Сверху</button>
                        <button class="alignment-btn active" data-target="vertical" data-value="middle" onclick="selectVerticalAlignment('middle')">↕️ Центр</button>
                        <button class="alignment-btn" data-target="vertical" data-value="bottom" onclick="selectVerticalAlignment('bottom')">⬇️ Снизу</button>
                    </div>
                </div>

                <!-- Выравнивание заголовка (скрывается при noTitle) -->
                <div class="alignment-section" id="titleAlignmentSection" style="margin-top: 16px;">
                    <label class="slider-label">Выравнивание заголовка (горизонталь)</label>
                    <div class="alignment-buttons-row">
                        <button class="alignment-btn" data-target="title" data-value="left" onclick="selectTitleAlignment('left')">⬅️ Слева</button>
                        <button class="alignment-btn active" data-target="title" data-value="center" onclick="selectTitleAlignment('center')">↔️ Центр</button>
                        <button class="alignment-btn" data-target="title" data-value="right" onclick="selectTitleAlignment('right')">➡️ Справа</button>
                    </div>
                </div>

                <!-- Выравнивание текста (всегда видно) -->
                <div class="alignment-section" style="margin-top: 16px;">
                    <label class="slider-label">Выравнивание текста (горизонталь)</label>
                    <div class="alignment-buttons-row">
                        <button class="alignment-btn active" data-target="text" data-value="left" onclick="selectTextAlignment('left')">⬅️ Слева</button>
                        <button class="alignment-btn" data-target="text" data-value="center" onclick="selectTextAlignment('center')">↔️ Центр</button>
                        <button class="alignment-btn" data-target="text" data-value="right" onclick="selectTextAlignment('right')">➡️ Справа</button>
                    </div>
                </div>

                <button class="accordion-button" id="advancedTextBtn">
                    <span>Дополнительные настройки</span>
                    <span class="arrow">▼</span>
                </button>
                <div class="accordion-content" id="advancedTextContent">
                    <div class="shadow-toggle" onclick="document.getElementById('shadowToggle').click()">
                        <input 
                            type="checkbox" 
                            id="shadowToggle"
                            onchange="toggleShadow(this.checked)"
                            onclick="event.stopPropagation()">
                        <label for="shadowToggle" onclick="event.stopPropagation()">Добавить тень</label>
                    </div>

                    <div class="shadow-controls" id="shadowControls">
                        <label class="slider-label">Размытие</label>
                        <div class="slider-container-new">
                            <span class="slider-min">четко</span>
                            <input 
                                type="range"
                                class="slider" 
                                min="0" 
                                max="10" 
                                value="4" 
                                step="1"
                                id="shadowBlurSlider"
                                oninput="updateShadowBlur(this.value)">
                            <span class="slider-max">мягко</span>
                        </div>

                        <label class="slider-label">Смещение</label>
                        <div class="slider-container-new">
                            <span class="slider-min">близко</span>
                            <input 
                                type="range"
                                class="slider" 
                                min="0" 
                                max="10" 
                                value="2" 
                                step="1"
                                id="shadowOffsetSlider"
                                oninput="updateShadowOffset(this.value)">
                            <span class="slider-max">далеко</span>
                        </div>

                        <div class="color-picker-wrapper">
                            <label for="shadowColorPicker">Цвет тени</label>
                            <input 
                                type="color" 
                                class="color-picker" 
                                id="shadowColorPicker"
                                value="#000000"
                                onchange="updateShadowColor(this.value)">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <label class="switch">
                    <input type="checkbox" id="applyTextToAll" />
                    <span class="slider" aria-hidden="true"></span>
                    <span class="switch-text">Применить ко всем слайдам</span>
                </label>
                <button class="save-btn" onclick="applyText()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Format Modal -->
    <div class="modal" id="formatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Формат слайда</h3>
                <button class="close-btn" onclick="closeModal('format')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="section-title">ВЫБЕРИТЕ ФОРМАТ</div>
                <div class="ratio-buttons">
                    <button class="ratio-btn selected" onclick="selectRatio('4-5', this)">
                        <div style="margin-bottom: 8px;">&#127904;</div>
                        Карусель<br>4:5<br><span style="font-size: 11px; color: #8e8e8e;">1080×1350</span>
                    </button>
                    <button class="ratio-btn" onclick="selectRatio('1-1', this)">
                        <div style="margin-bottom: 8px;">⬜</div>
                        Квадрат<br>1:1<br><span style="font-size: 11px; color: #8e8e8e;">1080×1080</span>
                    </button>
                    <button class="ratio-btn" onclick="selectRatio('9-16', this)">
                        <div style="margin-bottom: 8px;">&#127902;&#65039;</div>
                        Stories<br>9:16<br><span style="font-size: 11px; color: #8e8e8e;">1080×1920</span>
                    </button>
                </div>
                <p style="margin-top: 16px; color: #8e8e8e; font-size: 13px;">
                    При изменении формата он применится ко всем слайдам автоматически
                </p>
                <button class="save-btn" onclick="closeModal('format')">Готово</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content" style="max-height: auto;">
            <div class="modal-header">
                <h3>Подтверждение удаления</h3>
            </div>
            <div class="modal-body">
                <p style="font-size: 16px; line-height: 1.5; margin-bottom: 20px;">
                    Удалить этот слайд? Это действие нельзя отменить.
                </p>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-delete" style="flex: 1; padding: 12px;" onclick="deleteCurrentSlide()">Да, удалить</button>
                    <button class="save-btn" style="flex: 1; padding: 12px; background: #8e8e8e;" onclick="closeModal('delete')">Нет, оставить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div class="gallery-modal" id="galleryModal">
        <div class="gallery-header">
            <h2 class="gallery-title">Галерея готовых слайдов</h2>
            <button class="gallery-close-btn" onclick="closeGallery()">&times;</button>
        </div>
        <div class="gallery-container" id="galleryContainer">
            <div class="gallery-loading">Загрузка...</div>
        </div>
        <div class="gallery-hint">
            ???? Совет: долгий тап (зажмите) на картинке для быстрого сохранения<br>
            или используйте кнопку "Скачать" под каждым слайдом
        </div>
    </div>

    <!-- Welcome Modal (Приветственное окно) -->
    <div class="modal active" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-step" id="welcomeStep1">
                <div class="welcome-header">
                    <h2>&#128075; Привет!</h2>
                    <p>Я помогу создать карусель</p>
                </div>
                <div class="welcome-buttons">
                    <button class="welcome-btn" onclick="closeWelcomeModal()">
                        ✏️ Перейти в редактор
                    </button>
                    <button class="welcome-btn magic-btn" onclick="showImportStep()">
                        ✨ Волшебная кнопка
                    </button>
                </div>
            </div>

            <div class="welcome-step" id="welcomeStep2" style="display: none;">
                <div class="welcome-header">
                    <h2>✨ Импорт из текста</h2>
                    <p>Вставьте текст карусели из Telegram бота</p>
                </div>
                <div class="import-area">
                    <textarea 
                        id="importTextArea" 
                        placeholder="Слайд 1 (Обложка)&#10;ЗАГОЛОВОК ПЕРВОГО СЛАЙДА&#10;Подзаголовок или текст&#10;&#10;Слайд 2&#10;Заголовок второго слайда&#10;Текст второго слайда..."></textarea>
                    <div class="import-hint">
                        &#128203; Формат: каждый слайд начинается с "Слайд N"
                    </div>
                </div>
                <div class="welcome-buttons">
                    <button class="welcome-btn secondary" onclick="showWelcomeStep()">
                        ⬅ Назад
                    </button>
                    <button class="welcome-btn" onclick="importFromText()">
                        &#128228; Импортировать
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
*, *::before, *::after {
    touch-action: manipulation;
}
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .exporting, .exporting * {
            animation: none !important;
            transition: none !important;
            caret-color: transparent !important;
        }

        .header {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #dbdbdb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .btn-add {
            background: #0095f6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-delete {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .color-section { 
            margin-top: 8px; 
        }

        .palette-caption {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: .02em;
            color: #64748B;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .color-palette {
            --swatch: 42px;
            --gap: 10px;
            display: grid;
            grid-template-columns: repeat(5, var(--swatch));
            gap: var(--gap);
        }

        .color-swatch {
            width: var(--swatch);
            height: var(--swatch);
            border-radius: 10px;
            border: 1px solid rgba(15,23,42,.08);
            box-shadow: 0 6px 16px rgba(15,23,42,.08);
            cursor: pointer;
            padding: 0;
            outline: none;
            background: transparent;
        }

        .color-swatch:focus-visible {
            box-shadow: 0 0 0 3px rgba(59,130,246,.6);
        }

        .color-swatch.is-active {
            box-shadow: 0 0 0 3px rgba(59,130,246,.9), 0 6px 16px rgba(15,23,42,.08);
        }

        .color-swatch[data-color="#ffffff"] { 
            border-color: rgba(15,23,42,.15); 
        }

        .btn-delete:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-download {
            background: #34c759;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-download:hover {
            background: #2db24a;
        }

        .btn-download:active {
            transform: scale(0.95);
        }

        .download-menu {
            display: none;
            position: absolute;
            top: 52px;
            right: 16px;
            background: white;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }

        .download-menu.active {
            display: block;
        }

        .download-menu-item {
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-menu-item:hover {
            background: #f5f5f5;
        }

        .download-menu-item:active {
            background: #e0e0e0;
        }

        /* === ГАЛЕРЕЯ ПРЕДПРОСМОТРА === */
        .gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .gallery-modal.active {
            display: block;
        }

        .gallery-header {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }

        .gallery-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .gallery-close-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .gallery-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .gallery-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .gallery-slide-number {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #262626;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gallery-image-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f5f5f5;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
        }

        .gallery-image {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            -webkit-touch-callout: default;
        }

        .gallery-actions {
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.02);
        }

        .gallery-download-btn {
            flex: 1;
            background: #0095f6;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .gallery-download-btn:hover {
            background: #0084d9;
        }

        .gallery-download-btn:active {
            transform: scale(0.98);
        }

        .gallery-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            text-align: center;
            padding: 16px;
            margin-top: 8px;
        }

        .gallery-loading {
            color: white;
            text-align: center;
            padding: 40px 20px;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            .gallery-container {
                padding: 16px 12px;
                gap: 20px;
            }
            
            .gallery-image-wrapper {
                padding: 12px;
            }
        }
                
        /* ---------- БАЗА ---------- */

      .slide-preview{
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px 20px;
    background: #fafafa;
    position: relative;
    overflow: visible;  /* Было hidden, делаем visible */
    transition: transform .35s ease, opacity .35s ease, max-height .35s ease, padding .35s ease;
    transform-origin: top center;
    will-change: transform, opacity;
}

/* Добавьте wrapper для правильного отображения scaled canvas */
.slide-preview::before {
    content: '';
    display: block;
}

/* Для формата 4:5 (1080×1350 scaled до 324×405) */
.slide-canvas.ratio-4-5 {
    margin: 0 auto;
}

/* Для формата 1:1 (1080×1080 scaled до 324×324) */
.slide-canvas.ratio-1-1 {
    margin: 0 auto;
}

/* Для формата 9:16 (1080×1920 scaled до ~303×540) */
.slide-canvas.ratio-9-16 {
    margin: 0 auto;
}

        .nav-arrow{
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,.5);
            color: #fff;
            border: none;
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 10;
            transition: transform .2s ease, opacity .2s ease, background-color .2s ease;
        }

        .nav-arrow:active{ 
            background: rgba(0,0,0,.7); 
            transform: translateY(-50%) scale(.95); 
        }

        .nav-arrow.disabled{ 
            opacity: .3; 
            cursor: not-allowed; 
        }

        .nav-arrow.left{ 
            left: 10px; 
        }

        .nav-arrow.right{ 
            right: 10px; 
        }

       .slide-canvas{
    position: relative;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,.1);
    border-radius: 8px;
    overflow: hidden;
}

.slide-canvas.ratio-4-5{ 
    width: 324px;
    height: 405px;
}

.slide-canvas.ratio-9-16{ 
    width: 303px;
    height: 540px;
}

.slide-canvas.ratio-1-1{ 
    width: 324px;
    height: 324px;
}
        .slide-background{
            position: absolute; 
            inset: 0;
            background-size: cover; 
            background-position: center;
        }

        .slide-pattern{
            position: absolute; 
            inset: 0;
            opacity: .3; 
            background-repeat: repeat; 
            background-size: 20px 20px;
        }

        .slide-overlay{
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .slide-content{
            position: relative; 
            z-index: 1;
            padding: 40px 30px; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: center;
        }

       .slide-title{
    font-size: 32px; 
    font-weight: 700; 
    margin: 0;
    line-height: 1.2; 
    word-wrap: break-word;
    white-space: pre-wrap;
    word-break: break-word;  /* ДОБАВИТЬ */
    overflow-wrap: break-word;  /* ДОБАВИТЬ */
}

.slide-text{
    font-size: 16px; 
    line-height: 1.5; 
    word-wrap: break-word;
    white-space: pre-wrap;
    margin: 0;
    word-break: break-word;  /* ДОБАВИТЬ */
    overflow-wrap: break-word;  /* ДОБАВИТЬ */
}

       

        .slide-navigation{
            padding: 3px 0;
            background: #fff;
            border-top: 1px solid #efefef;
            border-bottom: 1px solid #dbdbdb;
            overflow: hidden;
            position: relative;
            margin-bottom: 8px;
            min-height: 52px;
            flex-shrink: 0;
        }

        .slide-nav-scroll{
            display: flex; 
            gap: 8px;
            padding: 0 16px;
            overflow-x: auto; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .slide-nav-scroll::-webkit-scrollbar{ 
            display: none; 
        }

        .slide-btn{
            min-width: 40px; 
            height: 40px; 
            flex-shrink: 0;
            border-radius: 8px; 
            border: 2px solid #dbdbdb; 
            background: #fff;
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: transform .2s ease, background-color .2s ease, color .2s ease, border-color .2s ease;
        }

        .slide-btn.active{ 
            background: #0095f6; 
            color: #fff; 
            border-color: #0095f6; 
        }

        .slide-btn:active{ 
            transform: scale(.95); 
        }

        .bottom-menu{
            background: #fff;
            border-top: 1px solid #dbdbdb;
            padding: 8px 12px;
            display: flex; 
            justify-content: space-around;
            position: relative;
            min-height: 64px; 
            flex-shrink: 0;
        }

        .menu-btn{
            background: none; 
            border: none;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 2px;
            color: #262626; 
            font-size: 11px; 
            cursor: pointer; 
            padding: 4px 8px;
        }

        .menu-btn.active{ 
            color: #0095f6; 
        }

        .menu-icon{ 
            font-size: 22px; 
        }

        /* ---------- МОДАЛКА ---------- */

        .modal{
            position: fixed; 
            inset: 0;
            display: none;
            align-items: flex-end;
            justify-content: center;
            background: rgba(0,0,0,.4);
            z-index: 9999;
            pointer-events: auto;
        }

        .modal.active{ 
            display: flex; 
        }

        .modal-content{
            position: relative;
            width: 100%; 
            max-width: 480px; 
            max-height: 70vh;
            border-radius: 16px 16px 0 0;
            background: #fff;
            animation: slideUp .3s ease;
            display: flex; 
            flex-direction: column;
        }

        @keyframes slideUp{ 
            from{ transform: translateY(100%) } 
            to{ transform: translateY(0) } 
        }

        .modal-header{
            padding: 16px;
            border-bottom: 1px solid #dbdbdb;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: sticky; 
            top: 0; 
            background: #fff; 
            z-index: 10;
        }

        .modal-header h3{ 
            font-size: 16px; 
            font-weight: 600; 
        }

        .modal-body{
            padding: 16px; 
            padding-bottom: 100px;
            overflow-y: auto; 
            flex: 1;
        }

        .modal-footer{
            position: sticky; 
            bottom: 0; 
            z-index: 20;
            background: #fff; 
            padding: 12px 16px; 
            border-top: 1px solid #efefef;
            display: flex; 
            align-items: center; 
            gap: 12px;
        }

        /* ---------- СОСТОЯНИЕ: МОДАЛКА ОТКРЫТА ---------- */

        .container.modal-open .slide-preview{
            transform: translateY(-6vh) scale(.9);
            max-height: 32vh;
            padding: 6px 0 0 0 !important;
            display: flex;
            align-items: flex-start !important;
            justify-content: center;
            opacity: .98;
            z-index: 1;
        }

   .container.modal-open .slide-canvas.ratio-4-5{ 
    transform: scale(0.74) translateY(-16px);
}

.container.modal-open .slide-canvas.ratio-1-1{ 
    transform: scale(0.72) translateY(-16px);
}

.container.modal-open .slide-canvas.ratio-9-16{ 
    transform: scale(0.58) translateY(-14px);
}
        .container.modal-open .slide-navigation{ 
            pointer-events: none; 
            opacity: .6; 
        }

        .container.modal-open .nav-arrow{
            transform: translateY(-50%) scale(.85);
            pointer-events: none;
        }

        /* ---------- МОБИЛЬНАЯ КОРРЕКЦИЯ ---------- */
        @media (max-width: 600px){
            .container.modal-open .slide-preview{
                transform: translateY(-6vh) scale(.82);
                max-height: 28vh;
            }
            .container.modal-open .slide-canvas{ 
                transform: scale(.7) translateY(-12px); 
            }
            .container.modal-open .slide-canvas.ratio-9-16{ 
                transform: scale(.52) translateY(-12px); 
            }
        }

        /* ---------- ACCESSIBILITY ---------- */
        @media (prefers-reduced-motion: reduce){
            .slide-preview, .slide-canvas, .nav-arrow{ 
                transition: none !important; 
            }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #8e8e8e;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .template-card {
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 4/5;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .template-card:hover {
            border-color: #0095f6;
        }

        .template-card.selected {
            border-color: #0095f6;
            background: #e7f3ff;
        }

        .template-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .template-text {
            font-size: 12px;
            line-height: 1.4;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .color-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .color-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .color-option:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .color-option.selected {
            border-color: #0095f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3), 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .upload-btn {
            width: 100%;
            padding: 40px;
            border: 2px dashed #dbdbdb;
            border-radius: 8px;
            background: #fafafa;
            cursor: pointer;
            text-align: center;
            margin: 0;
            display: block;
        }
        
        .upload-section {
            background: #f8f8f8;
            padding: 16px;
            border-radius: 8px;
            margin-top: 24px;
            margin-bottom: 0;
        }
        
        .pattern-section {
            margin-top: 12px;
            padding-top: 0;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .pattern-option {
            aspect-ratio: 1;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .pattern-option.selected {
            border-color: #0095f6;
        }

        .pattern-preview {
            width: 100%;
            height: 100%;
            background-repeat: repeat;
            background-size: 15px 15px;
        }

        .input-group {
            margin: 16px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: #8e8e8e;
        }

        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .slider-group {
            margin: 16px 0;
        }

        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .slider {
            width: 100%;
            margin: 8px 0;
        }

        .ratio-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .ratio-btn {
            padding: 16px;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .ratio-btn.selected {
            border-color: #0095f6;
            background: #e7f3ff;
            color: #0095f6;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: #8e8e8e;
        }
        
        .section-title:first-of-type {
            margin-top: 0;
        }

        .switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: #fafafa;
            border-radius: 10px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .switch input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch .slider {
            position: relative;
            width: 44px;
            height: 24px;
            border-radius: 999px;
            background: #d1d5db;
            transition: background .18s ease;
            flex: 0 0 auto;
        }

        .switch .slider::after {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,.2);
            transition: transform .18s ease;
        }

        .switch input[type="checkbox"]:checked + .slider {
            background: #0095f6;
        }

        .switch input[type="checkbox"]:checked + .slider::after {
            transform: translateX(20px);
        }

        .switch-text {
            font-size: 14px;
            color: #111827;
        }

        .switch input[type="checkbox"]:focus + .slider {
            outline: 2px solid #93c5fd;
            outline-offset: 2px;
        }

        .save-btn {
            margin-left: auto;
            width: auto;
            background: #0095f6;
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .save-btn:hover { 
            filter: brightness(.95); 
        }

        .save-btn:active { 
            transform: translateY(1px); 
        }

        .toggle-section {
            margin: 0;
        }

        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
        }

        .toggle-arrow {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .toggle-arrow.open {
            transform: rotate(180deg);
        }

        .pattern-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .remove-pattern-btn {
            padding: 4px 12px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .remove-pattern-btn.active {
            display: block;
        }

        .advanced-settings {
            padding: 16px 0;
            display: none;
        }

        .advanced-settings.active {
            display: block;
        }
        
        .advanced-settings-toggle {
            margin-top: 16px;
        }
        
        .advanced-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            margin-top: 12px;
        }
        
        .advanced-arrow {
            font-size: 16px;
            transition: transform 0.3s;
        }
        
        .advanced-arrow.open {
            transform: rotate(180deg);
        }
        
        .advanced-settings-content {
            display: none;
            padding-top: 12px;
        }
        
        .advanced-settings-content.active {
            display: block;
        }

        .text-input-group {
            margin-bottom: 16px;
        }

        .text-input-group label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .text-input-group input,
        .text-input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            transition: border-color 0.2s;
        }

        .text-input-group input:focus,
        .text-input-group textarea:focus {
            border-color: #0095f6;
            outline: none;
        }

        .text-input-group textarea {
            min-height: 60px;
            max-height: 250px;
            overflow-y: hidden;
        }

        .accordion-button {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            margin-top: 16px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .accordion-button:hover {
            background: #e9ecef;
        }

        .accordion-button .arrow {
            font-size: 14px;
            transition: transform 0.3s;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-content.open {
            margin-top: 8px;
            padding: 16px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            background: white;
            max-height: 2000px;
        }

        .font-settings {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .font-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-family: inherit;
        }

        .font-select:focus {
            border-color: #0095f6;
            outline: none;
        }

        .style-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .style-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .style-btn.active {
            background: #0095f6;
            color: white;
            border-color: #0095f6;
        }

        .alignment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 60px;
            margin-top: 12px;
        }

        .alignment-cell {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            background: white;
            transition: all 0.2s;
        }

        .alignment-cell::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background: #111827;
            border-radius: 3px;
            top: auto; 
            right: auto; 
            bottom: auto; 
            left: auto;
            transform: none;
        }

        .alignment-cell[data-align="top-left"]::after { top: 8px; left: 8px; }
        .alignment-cell[data-align="top-center"]::after { top: 8px; left: 50%; transform: translateX(-50%); }
        .alignment-cell[data-align="top-right"]::after { top: 8px; right: 8px; }
        .alignment-cell[data-align="middle-left"]::after { top: 50%; left: 8px; transform: translateY(-50%); }
        .alignment-cell[data-align="middle-center"]::after { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .alignment-cell[data-align="middle-right"]::after { top: 50%; right: 8px; transform: translateY(-50%); }
        .alignment-cell[data-align="bottom-left"]::after { bottom: 8px; left: 8px; }
        .alignment-cell[data-align="bottom-center"]::after { bottom: 8px; left: 50%; transform: translateX(-50%); }
        .alignment-cell[data-align="bottom-right"]::after { bottom: 8px; right: 8px; }

        .alignment-cell.selected {
            border-color: #0095f6;
            background: rgba(0, 149, 246, 0.1);
        }

        .alignment-cell.selected::after {
            background: #0095f6;
        }

        .alignment-section {
            margin-bottom: 16px;
        }

        .alignment-buttons-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .alignment-btn {
            padding: 12px 8px;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .alignment-btn.active {
            background: #0095f6;
            color: white;
            border-color: #0095f6;
        }

        .alignment-btn:hover:not(.active) {
            border-color: #0095f6;
            background: #e7f3ff;
        }

        .alignment-btn:active {
            transform: scale(0.98);
        }
       
        .shadow-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .shadow-toggle:hover {
            background: #e9ecef;
        }

        .shadow-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #0095f6;
        }

        .shadow-toggle label {
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #262626;
            margin: 0;
        }

        .shadow-controls {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            transition: max-height .3s ease, opacity .25s ease, margin-top .3s ease;
        }

        .shadow-controls.active {
            opacity: 1;
            margin-top: 12px;
        }

        .slider-container-new {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        .slider-min,
        .slider-max {
            font-size: 12px;
            color: #8e8e8e;
            min-width: 50px;
            text-align: center;
        }

        .slider-min {
            text-align: right;
        }

        .slider-max {
            text-align: left;
        }

        .slider-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 4px;
            margin-top: 12px;
        }

        .slider-label:first-child {
            margin-top: 0;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .color-picker-wrapper label {
            font-size: 14px;
            font-weight: 500;
            color: #262626;
            margin: 0;
        }

        .color-picker {
            width: 60px;
            height: 40px;
            border: 2px solid #dbdbdb;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .color-picker:hover {
            border-color: #0095f6;
        }

        .color-picker:focus {
            outline: none;
            border-color: #0095f6;
            box-shadow: 0 0 0 3px rgba(0, 149, 246, 0.1);
        }

        .welcome-content{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,.2);
            animation: welcomeAppear .3s ease;
            max-height: calc(100dvh - 48px);
            overflow: auto;
        }

        @keyframes welcomeAppear {
            from { opacity: 0; transform: scale(0.9); }
            to   { opacity: 1; transform: scale(1); }
        }

        .welcome-step {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .welcome-header {
            text-align: center;
        }

        .welcome-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #262626;
        }

        .welcome-header p {
            font-size: 16px;
            color: #8e8e8e;
            line-height: 1.5;
        }

        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .welcome-btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #0095f6;
            color: white;
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 149, 246, 0.3);
        }

        .welcome-btn:active {
            transform: translateY(0);
        }

        .welcome-btn.magic-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .welcome-btn.magic-btn:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .welcome-btn.secondary {
            background: #dbdbdb;
            color: #262626;
        }

        .welcome-btn.secondary:hover {
            background: #c7c7c7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .import-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #importTextArea {
            width: 100%;
            min-height: 300px;
            padding: 16px;
            border: 2px solid #dbdbdb;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            transition: border-color 0.2s;
        }

        #importTextArea:focus {
            border-color: #0095f6;
            outline: none;
        }

        #importTextArea::placeholder {
            color: #8e8e8e;
            line-height: 1.6;
        }

        .import-hint {
            font-size: 13px;
            color: #8e8e8e;
            padding: 8px 12px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        #welcomeModal.hidden {
            display: none !important;
        }

        /* === СТИЛИ ДЛЯ ПОДЛОЖКИ === */
        .overlay-section {
            margin-top: 16px;
            padding-top: 0;
        }

        .remove-overlay-btn {
            padding: 4px 12px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .remove-overlay-btn.active {
            display: block;
        }

        .overlay-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .no-scroll { 
            overflow: hidden !important; 
            touch-action: none; 
        }
    </style>
     <script>
// Разрешаем клики внутри любых контейнеров контента модалки
const CONTENT_SELECTORS = '.modal-content, .welcome-content, .modal__content, [data-modal-content]';

document.addEventListener('click', function(e) {
  const overlay = e.target.closest('.modal.active, .modal.is-open');
  if (!overlay) return;
  const insideContent = e.target.closest(CONTENT_SELECTORS);
  if (!insideContent) {
    e.preventDefault();
    e.stopImmediatePropagation();
  }
}, true);

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.querySelector('.modal.active, .modal.is-open')) {
    e.preventDefault();
    e.stopImmediatePropagation();
  }
}, true);

(function initShadowAutoResize(){
  const sc  = document.getElementById('shadowControls');
  const acc = document.getElementById('advancedTextContent');
  if (!sc || !acc) return;

  const ro = new ResizeObserver(() => {
    if (acc.classList.contains('open')) {
      acc.style.maxHeight = acc.scrollHeight + 'px';
    }
  });
  ro.observe(sc);

  requestAnimationFrame(() => {
    const on = document.getElementById('shadowToggle')?.checked;
    sc.classList.toggle('active', !!on);
    sc.style.maxHeight = on ? sc.scrollHeight + 'px' : '0px';
    if (acc.classList.contains('open')) {
      acc.style.maxHeight = acc.scrollHeight + 'px';
    }d
  });

  window.openAccordion = function(id){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add('open');
    el.style.maxHeight = el.scrollHeight + 'px';
  };
  window.closeAccordion = function(id){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('open');
    if (id === 'advancedTextContent') {
      sc.style.maxHeight = sc.classList.contains('active') ? sc.scrollHeight + 'px' : '0px';
    }
    el.style.maxHeight = '0px';
  };
})();

// === ФУНКЦИИ ПРИВЕТСТВЕННОГО ОКНА ===
function closeWelcomeModal() {
    const modal = document.getElementById('welcomeModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function showImportStep() {
    const step1 = document.getElementById('welcomeStep1');
    const step2 = document.getElementById('welcomeStep2');
    if (step1) step1.style.display = 'none';
    if (step2) step2.style.display = 'flex';
}

function showWelcomeStep() {
    const step1 = document.getElementById('welcomeStep1');
    const step2 = document.getElementById('welcomeStep2');
    const textarea = document.getElementById('importTextArea');
    
    if (step1) step1.style.display = 'flex';
    if (step2) step2.style.display = 'none';
    if (textarea) textarea.value = '';
}

// === КОНСТАНТА МАСШТАБИРОВАНИЯ ===
const PREVIEW_SCALE = 0.3;
const PREVIEW_WIDTH = 1080;

let slides = [
    {
        title: 'Заголовок слайда',
        text: 'Это основной текст для вашего слайда. Здесь можно рассказать о чём-то важном.',
        titleSize: 106,
        textSize: 53,
        bgColor: '#ffffff',
        bgImage: null,
        textColor: '#000000',
        titleColor: '#000000',
        pattern: null,
        patternOpacity: 0.3,
        patternScale: 66,
        isTitle: true,
        noTitle: false,
        titleFont: 'Montserrat',
        textFont: 'Roboto',
        titleBold: true,
        titleItalic: false,
        textBold: false,
        textItalic: false,
        contentAlignment: { vertical: 'middle' },
        titleAlignment: { horizontal: 'center' },
        textAlignment: { horizontal: 'left' },
        paddingTop: 30,
        paddingBottom: 30,
        paddingLeft: 30,
        paddingRight: 30,
        titleLineHeight: 1.2,
        textLineHeight: 1.5,
        textShadow: false,
        shadowBlur: 4,
        shadowOffset: 2,
        shadowColor: '#000000',
        overlayEnabled: false,
        overlayColor: '#000000',
        overlayOpacity: 0.8,
        overlayHeight: 60
    }
];

let currentSlide = 0;
let currentRatio = '4-5';
let selectedTemplate = null;
let previewTimeout;
let templatePreviewState = null;

const templates = [
    { name: 'Минимализм', bg: '#ffffff', color: '#000000', title: 'Простой заголовок', text: 'Краткое описание идеи в двух предложениях.' },
    { name: 'Тёмная тема', bg: '#1a1a1a', color: '#ffffff', title: 'Ночной стиль', text: 'Элегантный тёмный дизайн для современного контента.' },
    { name: 'Океан', bg: '#0077be', color: '#ffffff', title: 'Морская волна', text: 'Свежий голубой дизайн для летнего настроения.' },
    { name: 'Закат', bg: '#ff6b6b', color: '#ffffff', title: 'Тёплые тона', text: 'Яркий и энергичный дизайн с красными оттенками.' },
    { name: 'Природа', bg: '#2ecc71', color: '#ffffff', title: 'Зелёный сад', text: 'Экологичный и свежий стиль для природной тематики.' },
    { name: 'Лаванда', bg: '#9b59b6', color: '#ffffff', title: 'Фиолетовые сны', text: 'Креативный и художественный подход к дизайну.' },
    { name: 'Солнце', bg: '#f39c12', color: '#ffffff', title: 'Золотой час', text: 'Тёплый оранжевый для позитивного настроения.' },
    { name: 'Небо', bg: '#3498db', color: '#ffffff', title: 'Чистое небо', text: 'Классический синий для профессионального контента.' },
    { name: 'Пастель', bg: '#ffeaa7', color: '#2d3436', title: 'Мягкие тона', text: 'Нежный пастельный дизайн для лёгкого контента.' },
    { name: 'Коралл', bg: '#fd79a8', color: '#ffffff', title: 'Розовая мечта', text: 'Женственный и стильный розовый оттенок.' },
    { name: 'Мята', bg: '#81ecec', color: '#2d3436', title: 'Свежая мята', text: 'Освежающий бирюзовый для летнего контента.' },
    { name: 'Персик', bg: '#fab1a0', color: '#ffffff', title: 'Персиковый сок', text: 'Тёплый персиковый для уютного настроения.' },
    { name: 'Графит', bg: '#2d3436', color: '#ffffff', title: 'Тёмный графит', text: 'Строгий и профессиональный тёмно-серый стиль.' },
    { name: 'Лимон', bg: '#fdcb6e', color: '#2d3436', title: 'Лимонный фреш', text: 'Яркий жёлтый для энергичного контента.' },
    { name: 'Контраст', bg: '#000000', color: '#ffffff', title: 'Чёрно-белый', text: 'Максимальный контраст для чёткого сообщения.' }
];

const colors = [
    '#FDFCFB', '#000000', '#EDEAE7', '#E4DEDF', '#DED8D0',
    '#F7E3B4', '#EED8A9', '#E9CFA3', '#E1BFA0', '#D7A875',
    '#F3C1B0', '#E7B6A8', '#DEAFA7', '#C68D7A', '#B96B5E',
    '#E0E8E3', '#D2E3DC', '#B8D8D0', '#A8CBC4', '#8BB8AD',
    '#F6CDB8', '#EAB5A2', '#CDB6E3', '#A7C3E1', '#8E3B46',
    '#9C6644', '#7D5A50', '#556B58', '#5C728A'
];

// Новый, исправленный массив PATTERNS
const patterns = [
            { 
                id: 0, 
                name: 'Точки', 
                css: 'radial-gradient(circle, currentColor 1px, transparent 1px)',
                baseSize: 2, // Базовый размер тайла в пикселях (10x10)
                type: 'dot' 
            },
            { 
                id: 1, 
                name: 'Вертикаль', 
                css: 'repeating-linear-gradient(90deg, currentColor 0px, currentColor 2px, transparent 2px, transparent)',
                baseSize: 2, // Базовый размер тайла (4px = 2px линия + 2px прозрачность)
                type: 'vertical-line'
            },
            { 
                id: 2, 
                name: 'Сетка', 
                css: 'linear-gradient(currentColor 1px, transparent 1px), linear-gradient(90deg, currentColor 1px, transparent 1px)',
                baseSize: 5, // Базовый размер тайла в пикселях (15x15)
                type: 'grid'
            },
            { 
                id: 3, // НОВЫЙ УЗОР
                name: 'Горизонталь', 
                css: 'repeating-linear-gradient(0deg, currentColor 0px, currentColor 2px, transparent 2px, transparent)',
                baseSize: 2, // Базовый размер тайла (4px = 2px линия + 2px прозрачность)
                type: 'horizontal-line'
            }
        ];

const paddingMap = [10, 20, 30, 40, 50];

// === АВТОСОХРАНЕНИЕ ===
const AUTOSAVE_LS_KEY = 'carouselDraftV1';
const AUTOSAVE_DEBOUNCE_MS = 2000;

let __autosaveTimer = null;
let __lastStable = null;
let __isSaving = false;

function normalizeSlide(s = {}) {
  const toNum = (v, d=null) => (typeof v === 'number' && Number.isFinite(v)) ? v
                    : (typeof v === 'string' && v.trim()!=='' && !Number.isNaN(+v)) ? +v : d;
  const toStr = (v, d=null) => (typeof v === 'string') ? v : d;
  const toBool = (v) => !!v;
  const clamp = (v, lo, hi, d) => {
    const n = toNum(v, null);
    if (n === null) return d;
    return (n < lo || n > hi) ? d : n;
  };
  const clampPos = (v, d=0) => {
    const n = toNum(v, null);
    if (n === null) return d;
    return n < 0 ? d : n;
  };

  let contentAlignment = s.contentAlignment;
  let titleAlignment = s.titleAlignment;
  let textAlignment = s.textAlignment;

  if (s.alignment && !contentAlignment) {
    const old = String(s.alignment);
    const parts = old.split('-');
    const vertical = parts[0] || 'middle';
    const horizontal = parts[1] || 'left';
    contentAlignment = { vertical };
    titleAlignment = { horizontal: horizontal === 'center' ? 'center' : horizontal };
    textAlignment = { horizontal };
  }

  if (!contentAlignment) contentAlignment = { vertical: 'middle' };
  if (!titleAlignment) titleAlignment = { horizontal: 'center' };
  if (!textAlignment) textAlignment = { horizontal: 'left' };

  const validVertical = ['top', 'middle', 'bottom'];
  const validHorizontal = ['left', 'center', 'right'];

  if (!validVertical.includes(contentAlignment.vertical)) {
    contentAlignment.vertical = 'middle';
  }
  if (!validHorizontal.includes(titleAlignment.horizontal)) {
    titleAlignment.horizontal = 'center';
  }
  if (!validHorizontal.includes(textAlignment.horizontal)) {
    textAlignment.horizontal = 'left';
  }

  const textColorValue = toStr(s.textColor, '#000000');
  const titleColorValue = toStr(s.titleColor) || textColorValue;

  return {
    title: toStr(s.title, null),
    text: toStr(s.text, null),
    titleSize: toNum(s.titleSize, null),
    textSize: toNum(s.textSize, null),
    bgColor: toStr(s.bgColor, '#ffffff'),
    textColor: textColorValue,
    titleColor: titleColorValue,
    shadowColor: toStr(s.shadowColor, '#000000'),
    bgImage: null,
    pattern: s.pattern == null ? null : String(s.pattern),
    patternOpacity: clamp(s.patternOpacity, 0, 1, 0),
    patternScale: clampPos(s.patternScale, 0),
    titleFont: toStr(s.titleFont, null),
    textFont: toStr(s.textFont, null),
    titleBold: toBool(s.titleBold),
    titleItalic: toBool(s.titleItalic),
    textBold: toBool(s.textBold),
    textItalic: toBool(s.textItalic),
    contentAlignment,
    titleAlignment,
    textAlignment,
    paddingTop: toNum(s.paddingTop, 0),
    paddingBottom: toNum(s.paddingBottom, 0),
    paddingLeft: toNum(s.paddingLeft, 0),
    paddingRight: toNum(s.paddingRight, 0),
    titleLineHeight: clamp(s.titleLineHeight, 0.8, 3.0, 1.2),
    textLineHeight: clamp(s.textLineHeight, 0.8, 3.0, 1.5),
    textShadow: toBool(s.textShadow),
    shadowBlur: toNum(s.shadowBlur, 0),
    shadowOffset: toNum(s.shadowOffset, 0),
    isTitle: toBool(s.isTitle),
    noTitle: toBool(s.noTitle),
    overlayEnabled: toBool(s.overlayEnabled),
    overlayColor: toStr(s.overlayColor, '#000000'),
    overlayOpacity: clamp(s.overlayOpacity, 0, 1, 0.8),
    overlayHeight: clamp(s.overlayHeight, 0, 100, 60)
  };
}

function buildCurrentSnapshot() {
  const cleanSlides = (Array.isArray(slides) ? slides : []).map(normalizeSlide);
  let idx = Number.isInteger(currentSlide) ? currentSlide : 0;
  if (idx < 0 || idx >= cleanSlides.length) idx = 0;

  return {
    version: '1.0',
    timestamp: new Date().toISOString(),
    slidesCount: cleanSlides.length,
    hadImages: false,
    currentSlide: idx,
    currentRatio: (typeof currentRatio === 'string' ? currentRatio : '4-5'),
    slides: cleanSlides
  };
}

function buildStableJson() {
  const snap = buildCurrentSnapshot();
  const stable = {
    version: snap.version,
    slidesCount: snap.slidesCount,
    hadImages: snap.hadImages,
    currentSlide: snap.currentSlide,
    currentRatio: snap.currentRatio,
    slides: snap.slides
  };
  return { stableJson: JSON.stringify(stable), fullJson: JSON.stringify(snap) };
}

function __doSaveNow() {
  if (__isSaving) return;
  __isSaving = true;
  
  try {
    const { stableJson, fullJson } = buildStableJson();
    if (__lastStable !== null && stableJson === __lastStable) {
      return;
    }
    localStorage.setItem(AUTOSAVE_LS_KEY, fullJson);
    __lastStable = stableJson;
    console.log('[Autosave] saved');
  } catch (e) {
    console.error('[Autosave] save error:', e);
  } finally {
    __isSaving = false;
  }
}

function autosaveTouch() {
  clearTimeout(__autosaveTimer);
  __autosaveTimer = setTimeout(__doSaveNow, AUTOSAVE_DEBOUNCE_MS);
}
window.autosaveTouch = autosaveTouch;

function makeDefaultSlide() {
  return {
    title: 'Заголовок слайда',
    text: 'Это основной текст для вашего слайда.',
    titleSize: 106,
    textSize: 53,
    bgColor: '#ffffff',
    bgImage: null,
    textColor: '#000000',
    titleColor: '#000000',
    pattern: null,
    patternOpacity: 0.3,
    patternScale: 66,
    isTitle: true,
    noTitle: false,
    titleFont: 'Montserrat',
    textFont: 'Roboto',
    titleBold: true,
    titleItalic: false,
    textBold: false,
    textItalic: false,
    contentAlignment: { vertical: 'middle' },
    titleAlignment: { horizontal: 'center' },
    textAlignment: { horizontal: 'left' },
    paddingTop: 30,
    paddingBottom: 30,
    paddingLeft: 30,
    paddingRight: 30,
    titleLineHeight: 1.2,
    textLineHeight: 1.5,
    textShadow: false,
    shadowBlur: 4,
    shadowOffset: 2,
    shadowColor: '#000000',
    overlayEnabled: false,
    overlayColor: '#000000',
    overlayOpacity: 0.8,
    overlayHeight: 60
  };
}

function init() {
    renderTemplates();
    renderColors();
    renderPatterns();
    renderSlide();
    updateNavigation();
    updateDeleteButton();
}

function launchInit() {
  try {
    const raw = localStorage.getItem('carouselDraftV1');
    if (raw) {
      const saved = JSON.parse(raw);
      if (saved && Array.isArray(saved.slides)) {
        let arr = saved.slides.map(s => normalizeSlide({ ...s, bgImage: null }));
        if (!arr.length) {
          arr = [ makeDefaultSlide() ];
        }
        let idx = Number.isInteger(saved.currentSlide) ? saved.currentSlide : 0;
        if (idx < 0) idx = 0;
        if (idx >= arr.length) idx = arr.length - 1;
        slides = arr;
        currentSlide = idx;
        currentRatio = (typeof saved.currentRatio === 'string') ? saved.currentRatio : '4-5';
      }
    }
  } catch (e) {
    console.warn('[Autosave] restore failed:', e);
  }
  init();
}

document.addEventListener('DOMContentLoaded', launchInit, { once: true });

function renderTemplates() {
    const grid = document.getElementById('templateGrid');
    grid.innerHTML = templates.map((template, index) => `
        <div class="template-card" onclick="selectTemplate(${index})" 
             style="background: ${template.bg}; color: ${template.color}">
            <div class="template-title">${template.title}</div>
            <div class="template-text">${template.text}</div>
        </div>
    `).join('');
}

function renderColors() {
    const grid = document.getElementById('colorGrid');
    grid.innerHTML = colors.map(color => `
        <div class="color-option" style="background: ${color}" 
             onclick="selectColor('${color}')"></div>
    `).join('');
}

function renderPatterns() {
    const grid = document.getElementById('patternGrid');
    grid.innerHTML = patterns.map((pattern, index) => `
        <div class="pattern-option" onclick="selectPattern(${index})">
            <div class="pattern-preview" 
                 style="background-image: ${pattern.css}; color: #000;"></div>
        </div>
    `).join('');
}

function updateNavigation() {
    const navContainer = document.getElementById('slideNavigation');
    navContainer.innerHTML = slides.map((_, index) => `
        <button class="slide-btn ${index === currentSlide ? 'active' : ''}" 
             onclick="switchSlide(${index})">${index + 1}</button>
    `).join('');
    
    const activeBtn = navContainer.querySelector('.slide-btn.active');
    if (activeBtn) {
        activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
    
    updateArrows();
}

function updateArrows() {
    const prevBtn = document.getElementById('prevSlide');
    const nextBtn = document.getElementById('nextSlide');
    
    if (currentSlide === 0) {
        prevBtn.classList.add('disabled');
        prevBtn.disabled = true;
    } else {
        prevBtn.classList.remove('disabled');
        prevBtn.disabled = false;
    }
    
    if (currentSlide === slides.length - 1) {
        nextBtn.classList.add('disabled');
        nextBtn.disabled = true;
    } else {
        nextBtn.classList.remove('disabled');
        nextBtn.disabled = false;
    }
}

function previousSlide() {
    if (currentSlide > 0) {
        currentSlide--;
        renderSlide();
        updateNavigation();
    }
}

function nextSlide() {
    if (currentSlide < slides.length - 1) {
        currentSlide++;
        renderSlide();
        updateNavigation();
    }
}

function switchSlide(index) {
    currentSlide = index;
    renderSlide();
    updateNavigation();
    if (window.autosaveTouch) window.autosaveTouch();
}

function addSlide() {
    if (slides.length >= 15) {
        alert('Максимум 15 слайдов');
        return;
    }
    
    const lastSlide = slides[slides.length - 1];
    const newSlide = {
        ...lastSlide,
        title: '',
        text: '',
        isTitle: false,
        noTitle: false,
        titleSize: 106,
        titleColor: lastSlide.titleColor || '#000000',
        contentAlignment: { ...lastSlide.contentAlignment },
        titleAlignment: { ...lastSlide.titleAlignment },
        textAlignment: { ...lastSlide.textAlignment }
    };
    slides.push(newSlide);
    currentSlide = slides.length - 1;
    renderSlide();
    updateNavigation();
    updateDeleteButton();
    if (window.autosaveTouch) window.autosaveTouch();
}

function confirmDeleteSlide() {
    if (slides.length <= 1) {
        alert('Нельзя удалить последний слайд');
        return;
    }
    openModal('delete');
}

function deleteCurrentSlide() {
    if (slides.length <= 1) {
        alert('Нельзя удалить последний слайд');
        closeModal('delete');
        return;
    }
    
    slides.splice(currentSlide, 1);
    
    if (currentSlide > 0) {
        currentSlide--;
    } else {
        currentSlide = 0;
    }
    
    renderSlide();
    updateNavigation();
    closeModal('delete');
    updateDeleteButton();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateDeleteButton() {
    const deleteBtn = document.querySelector('.btn-delete');
    if (slides.length <= 1) {
        deleteBtn.disabled = true;
    } else {
        deleteBtn.disabled = false;
    }
}
const appContainer = document.querySelector('.container');
const root = document.documentElement;

function openModal(type){
  const modal = document.getElementById(`${type}Modal`);
  if (!modal) return;

  modal.classList.add('active');
  appContainer?.classList.add('modal-open');
  root.classList.add('no-scroll');
  document.body.classList.add('no-scroll');

  if (!modal._overlayBound) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal(type);
    });
    modal._overlayBound = true;
  }

  if (type === 'template') {
    const slide = slides[currentSlide];
    templatePreviewState = {
      bgColor: slide.bgColor,
      bgImage: slide.bgImage,
      textColor: slide.textColor,
      titleColor: slide.titleColor
    };
  }

  if (type === 'background') {
    const slide = slides?.[currentSlide] || {};
    
    const overlayColorPicker = document.getElementById('overlayColorPicker');
    const overlayOpacitySlider = document.getElementById('overlayOpacitySlider');
    const overlayHeightSlider = document.getElementById('overlayHeightSlider');
    const overlayOpacityValue = document.getElementById('overlayOpacityValue');
    const overlayHeightValue = document.getElementById('overlayHeightValue');
    
    if (overlayColorPicker) overlayColorPicker.value = slide.overlayColor || '#000000';
    if (overlayOpacitySlider) overlayOpacitySlider.value = (slide.overlayOpacity || 0.8) * 100;
    if (overlayHeightSlider) overlayHeightSlider.value = slide.overlayHeight || 60;
    if (overlayOpacityValue) overlayOpacityValue.textContent = Math.round((slide.overlayOpacity || 0.8) * 100) + '%';
    if (overlayHeightValue) overlayHeightValue.textContent = (slide.overlayHeight || 60) + '%';
    
    updateRemoveOverlayButton();
  }

  if (type === 'text') {
    const slide = slides?.[currentSlide] || {};

    let unifiedText = '';
    if (slide.title && slide.text) unifiedText = slide.title + '\n' + slide.text;
    else if (slide.title) unifiedText = slide.title;
    else unifiedText = slide.text || '';

    const uniInput = document.getElementById('unifiedTextInput');
    if (uniInput) {
      uniInput.value = unifiedText;
      autoResizeTextarea?.(uniInput);
      setTimeout(() => uniInput.focus(), 0);
    }

    const setVal = (id, val, prop = 'value') => {
      const el = document.getElementById(id);
      if (el != null && val != null) el[prop] = val;
    };
    const toggle = (sel, state) => {
      const el = document.querySelector(sel);
      if (el) el.classList.toggle('active', !!state);
    };

    setVal('noTitleCheckbox', slide.noTitle || false, 'checked');
    setVal('titleFont', slide.titleFont);
    setVal('textFont', slide.textFont);
    setVal('titleSizeSlider', slide.titleSize);
    setVal('textSizeSlider', slide.textSize);
    setVal('titleSizeValue', (slide.titleSize ?? '') + 'px', 'textContent');
    setVal('textSizeValue', (slide.textSize ?? '') + 'px', 'textContent');

    toggle('#titleBoldBtn', slide.titleBold);
    toggle('#titleItalicBtn', slide.titleItalic);
    toggle('#textBoldBtn', slide.textBold);
    toggle('#textItalicBtn', slide.textItalic);
    
    document.querySelectorAll('#titleColorGrid .color-option').forEach(option => {
        const optionColor = rgbToHex(window.getComputedStyle(option).backgroundColor);
        option.classList.toggle('selected', 
            optionColor.toLowerCase() === (slide.titleColor || '#ffffff').toLowerCase()
        );
    });
    
    document.querySelectorAll('#textColorGrid .color-option').forEach(option => {
        const optionColor = rgbToHex(window.getComputedStyle(option).backgroundColor);
        option.classList.toggle('selected', 
            optionColor.toLowerCase() === (slide.textColor || '#000000').toLowerCase()
        );
    });

    const titleAlignSection = document.getElementById('titleAlignmentSection');
    if (titleAlignSection) {
        titleAlignSection.style.display = slide.noTitle ? 'none' : 'block';
    }

    const verticalValue = slide.contentAlignment?.vertical || 'middle';
    document.querySelectorAll('[data-target="vertical"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === verticalValue);
    });

    const titleHorizontalValue = slide.titleAlignment?.horizontal || 'center';
    document.querySelectorAll('[data-target="title"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === titleHorizontalValue);
    });

    const textHorizontalValue = slide.textAlignment?.horizontal || 'left';
    document.querySelectorAll('[data-target="text"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === textHorizontalValue);
    });

    const idx = (v) => Math.max(0, (paddingMap || []).indexOf(v));
    setVal('paddingTopSlider', idx(slide.paddingTop));
    setVal('paddingBottomSlider', idx(slide.paddingBottom));
    setVal('paddingLeftSlider', idx(slide.paddingLeft));
    setVal('paddingRightSlider', idx(slide.paddingRight));

    setVal('shadowToggle', slide.textShadow || false, 'checked');
    const sc = document.getElementById('shadowControls');
    if (sc) sc.classList.toggle('active', !!slide.textShadow);
    setVal('shadowBlurSlider', slide.shadowBlur);
    setVal('shadowOffsetSlider', slide.shadowOffset);
    setVal('shadowColorPicker', slide.shadowColor);

    closeAllAccordions?.();
  }
}

function closeModal(type){
  const modal = document.getElementById(`${type}Modal`);
  if (!modal) return;

  if (type === 'template' && templatePreviewState) {
    const slide = slides[currentSlide];
    slide.bgColor = templatePreviewState.bgColor;
    slide.bgImage = templatePreviewState.bgImage;
    slide.textColor = templatePreviewState.textColor;
    slide.titleColor = templatePreviewState.titleColor;
    renderSlide();
    templatePreviewState = null;
  }

  modal.classList.remove('active');
  appContainer?.classList.remove('modal-open');
  root.classList.remove('no-scroll');
  document.body.classList.remove('no-scroll');
}

function selectTemplate(index) {
    selectedTemplate = index;
    document.querySelectorAll('.template-card').forEach((card, i) => {
        card.classList.toggle('selected', i === index);
    });
    
    const template = templates[index];
    slides[currentSlide].bgColor = template.bg;
    slides[currentSlide].bgImage = null;
    slides[currentSlide].textColor = template.color;
    slides[currentSlide].titleColor = template.color;
    renderSlide();
}

function applyTemplate() {
    if (selectedTemplate === null) return;
    
    const template = templates[selectedTemplate];
    const applyToAll = document.getElementById('applyToAll').checked;
    
    if (applyToAll) {
        slides.forEach(slide => {
            slide.bgColor = template.bg;
            slide.bgImage = null;
            slide.textColor = template.color;
            slide.titleColor = template.color;
        });
    } else {
        slides[currentSlide].bgColor = template.bg;
        slides[currentSlide].bgImage = null;
        slides[currentSlide].textColor = template.color;
        slides[currentSlide].titleColor = template.color;
    }
    
    templatePreviewState = null;
    
    renderSlide();
    closeModal('template');
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectColor(color) {
    slides[currentSlide].bgColor = color;
    slides[currentSlide].bgImage = null;
    renderSlide();
    
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelectorAll('.color-option').forEach(option => {
        const optionColor = rgbToHex(window.getComputedStyle(option).backgroundColor);
        if (optionColor.toLowerCase() === color.toLowerCase()) {
            option.classList.add('selected');
        }
    });
    
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectColorTitle(color) {
    slides[currentSlide].titleColor = color;
    renderSlide();
    
    document.querySelectorAll('#titleColorGrid .color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelectorAll('#titleColorGrid .color-option').forEach(option => {
        const optionColor = rgbToHex(window.getComputedStyle(option).backgroundColor);
        if (optionColor.toLowerCase() === color.toLowerCase()) {
            option.classList.add('selected');
        }
    });
    
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectColorText(color) {
    slides[currentSlide].textColor = color;
    renderSlide();
    
    document.querySelectorAll('#textColorGrid .color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelectorAll('#textColorGrid .color-option').forEach(option => {
        const optionColor = rgbToHex(window.getComputedStyle(option).backgroundColor);
        if (optionColor.toLowerCase() === color.toLowerCase()) {
            option.classList.add('selected');
        }
    });
    
    if (window.autosaveTouch) window.autosaveTouch();
}

function rgbToHex(rgb) {
    const result = rgb.match(/\d+/g);
    if (!result) return rgb;
    return '#' + result.map(x => {
        const hex = parseInt(x).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    }).join('');
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            slides[currentSlide].bgImage = e.target.result;
            renderSlide();
            if (window.autosaveTouch) window.autosaveTouch();
        };
        reader.readAsDataURL(file);
    }
}

function togglePatternSection() {
    const settings = document.getElementById('patternSettings');
    const arrow = document.getElementById('toggleArrow');
    settings.classList.toggle('active');
    arrow.classList.toggle('open');
}

function toggleAdvancedSettings() {
    const content = document.getElementById('advancedSettingsContent');
    const arrow = document.getElementById('advancedArrow');
    content.classList.toggle('active');
    arrow.classList.toggle('open');
}

function removePattern() {
    slides[currentSlide].pattern = null;
    renderSlide();
    updateRemoveButton();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateRemoveButton() {
    const removeBtn = document.getElementById('removePatternBtn');
    if (slides[currentSlide].pattern !== null) {
        removeBtn.classList.add('active');
    } else {
        removeBtn.classList.remove('active');
    }
}

function selectPattern(index) {
    const settings = document.getElementById('patternSettings');
    const arrow = document.getElementById('toggleArrow');
    settings.classList.add('active');
    arrow.classList.add('open');
    
    slides[currentSlide].pattern = index;
    renderSlide();
    updateRemoveButton();
    
    document.querySelectorAll('.pattern-option').forEach((option, i) => {
        option.classList.toggle('selected', i === index);
    });
    
    if (window.autosaveTouch) window.autosaveTouch();
}

function updatePatternOpacity(value) {
    document.getElementById('opacityValue').textContent = `${value}%`;
    slides[currentSlide].patternOpacity = value / 100;
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updatePatternScale(value) {
    document.getElementById('scaleValue').textContent = `${value}px`;
    slides[currentSlide].patternScale = value;
    
    // Ждём, пока DOM обновится, потом рендерим
    requestAnimationFrame(() => {
        renderSlide();
    });
    
    if (window.autosaveTouch) window.autosaveTouch();
}

// === НОВЫЕ ФУНКЦИИ ДЛЯ ПОДЛОЖКИ ===
function toggleOverlaySection() {
    const settings = document.getElementById('overlaySettings');
    const arrow = document.getElementById('overlayToggleArrow');
    settings.classList.toggle('active');
    arrow.classList.toggle('open');
}

function removeOverlay() {
    slides[currentSlide].overlayEnabled = false;
    renderSlide();
    updateRemoveOverlayButton();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateRemoveOverlayButton() {
    const removeBtn = document.getElementById('removeOverlayBtn');
    if (slides[currentSlide].overlayEnabled) {
        removeBtn.classList.add('active');
    } else {
        removeBtn.classList.remove('active');
    }
}

function updateOverlayColor(value) {
    slides[currentSlide].overlayColor = value;
    slides[currentSlide].overlayEnabled = true;
    renderSlide();
    updateRemoveOverlayButton();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateOverlayOpacity(value) {
    document.getElementById('overlayOpacityValue').textContent = `${value}%`;
    slides[currentSlide].overlayOpacity = value / 100;
    slides[currentSlide].overlayEnabled = true;
    renderSlide();
    updateRemoveOverlayButton();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateOverlayHeight(value) {
    document.getElementById('overlayHeightValue').textContent = `${value}%`;
    slides[currentSlide].overlayHeight = parseInt(value);
    slides[currentSlide].overlayEnabled = true;
    renderSlide();
    updateRemoveOverlayButton();
    if (window.autosaveTouch) window.autosaveTouch();
}
// === КОНЕЦ НОВЫХ ФУНКЦИЙ ДЛЯ ПОДЛОЖКИ ===

function applyBackground() {
    const applyToAll = document.getElementById('applyBgToAll')?.checked;
    
    if (applyToAll) {
        const current = slides[currentSlide];
        slides.forEach(slide => {
            slide.bgColor = current.bgColor;
            slide.bgImage = current.bgImage;
            slide.pattern = current.pattern;
            slide.patternOpacity = current.patternOpacity;
            slide.patternScale = current.patternScale;
            slide.overlayEnabled = current.overlayEnabled;
            slide.overlayColor = current.overlayColor;
            slide.overlayOpacity = current.overlayOpacity;
            slide.overlayHeight = current.overlayHeight;
        });
    }
    
    closeModal('background');
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateTitleSize(value) {
    document.getElementById('titleSizeValue').textContent = `${value}px`;
    slides[currentSlide].titleSize = parseInt(value);
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateTextSize(value) {
    document.getElementById('textSizeValue').textContent = `${value}px`;
    slides[currentSlide].textSize = parseInt(value);
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    
    const minHeight = 60;
    const maxHeight = 250;
    const scrollHeight = textarea.scrollHeight;
    const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
    
    textarea.style.height = newHeight + 'px';
    
    if (scrollHeight > maxHeight) {
        textarea.style.overflowY = 'auto';
    } else {
        textarea.style.overflowY = 'hidden';
    }
}

function handleUnifiedTextInput() {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(() => {
        let fullText = document.getElementById('unifiedTextInput').value;
        const slide = slides[currentSlide];
        const noTitle = document.getElementById('noTitleCheckbox').checked;
        
        fullText = fullText.replace(/^\s*\n+/, '');
        
        if (noTitle || !fullText.trim()) {
            slide.title = '';
            slide.text = fullText.trim() || '';
        } else {
            const firstNewlineIndex = fullText.search(/\n/);
            
            if (firstNewlineIndex !== -1) {
                let title = fullText.substring(0, firstNewlineIndex).trim();
                if (title.length > 100) {
                    title = title.substring(0, 100);
                }
                slide.title = title;
                slide.text = fullText.substring(firstNewlineIndex + 1).trim() || '';
            } else {
                const sentenceMatch = fullText.match(/^[^.!?]+[.!?]+/);
                
                if (sentenceMatch) {
                    let title = sentenceMatch[0].trim();
                    if (title.length > 100) {
                        title = title.substring(0, 100);
                    }
                    slide.title = title;
                    slide.text = fullText.substring(sentenceMatch[0].length).trim() || '';
                } else {
                    if (fullText.length > 100) {
                        slide.title = fullText.substring(0, 100).trim();
                        slide.text = fullText.substring(100).trim();
                    } else {
                        slide.title = fullText.trim();
                        slide.text = '';
                    }
                }
            }
        }
        
        renderSlide();
        autoFitFontSize();
    }, 150);
}

function autoFitFontSize() {
    const slide = slides[currentSlide];
    const canvas = document.querySelector('.slide-canvas');
    const content = document.querySelector('.slide-content');
    
    const originalTitleSize = slide.titleSize;
    const originalTextSize = slide.textSize;
    
    function isOverflowing() {
        return content.scrollHeight > canvas.clientHeight;
    }
    
    if (!isOverflowing()) {
        return;
    }
    
    const minTitleSize = 16;
    const minTextSize = 8;
    
    let attempts = 0;
    const maxAttempts = 50;
    
    while (isOverflowing() && attempts < maxAttempts) {
        if (slide.titleSize > minTitleSize) {
            slide.titleSize -= 1;
        }
        if (slide.textSize > minTextSize) {
            slide.textSize -= 1;
        }
        
        if (slide.titleSize <= minTitleSize && slide.textSize <= minTextSize) {
            break;
        }
        
        renderSlide();
        attempts++;
    }
    
    if (slide.titleSize !== originalTitleSize) {
        document.getElementById('titleSizeSlider').value = slide.titleSize;
        document.getElementById('titleSizeValue').textContent = slide.titleSize + 'px';
    }
    if (slide.textSize !== originalTextSize) {
        document.getElementById('textSizeSlider').value = slide.textSize;
        document.getElementById('textSizeValue').textContent = slide.textSize + 'px';
    }
}

function toggleNoTitle(checked) {
    slides[currentSlide].noTitle = checked;
    
    const titleAlignSection = document.getElementById('titleAlignmentSection');
    if (titleAlignSection) {
        titleAlignSection.style.display = checked ? 'none' : 'block';
    }
    
    handleUnifiedTextInput();
    if (window.autosaveTouch) window.autosaveTouch();
}

function closeAllAccordions() {
    const accordions = [
        'titleSettingsContent',
        'textSettingsContent',
        'alignmentContent',
        'advancedTextContent'
    ];
    
    accordions.forEach(id => {
        const content = document.getElementById(id);
        if (!content) return;
        const button = content.previousElementSibling;
        const arrow = button?.querySelector('.arrow');
        
        content.classList.remove('open');
        content.style.maxHeight = '0px';
        if (arrow) arrow.textContent = '▼';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const accordionBtns = ['titleSettingsBtn', 'textSettingsBtn', 'advancedTextBtn'];
    const contentIds = ['titleSettingsContent', 'textSettingsContent', 'advancedTextContent'];
    
    accordionBtns.forEach((btnId, i) => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.addEventListener('click', function() {
                toggleAccordion(contentIds[i], this);
            });
        }
    });
});

function toggleAccordion(contentId, button) {
    const content = document.getElementById(contentId);
    if (!content) return;
    const arrow = button.querySelector('.arrow');
    const isOpen = content.classList.contains('open');
    
    if (isOpen) {
        content.classList.remove('open');
        if (arrow) arrow.textContent = '▼';
        content.style.maxHeight = '0px';
    } else {
        content.classList.add('open');
        if (arrow) arrow.textContent = '▲';
        content.style.maxHeight = content.scrollHeight + 'px';
    }
}

function updateTitleFont(value) {
    slides[currentSlide].titleFont = value;
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateTextFont(value) {
    slides[currentSlide].textFont = value;
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function toggleTitleBold() {
    slides[currentSlide].titleBold = !slides[currentSlide].titleBold;
    document.getElementById('titleBoldBtn').classList.toggle('active');
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function toggleTitleItalic() {
    slides[currentSlide].titleItalic = !slides[currentSlide].titleItalic;
    document.getElementById('titleItalicBtn').classList.toggle('active');
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function toggleTextBold() {
    slides[currentSlide].textBold = !slides[currentSlide].textBold;
    document.getElementById('textBoldBtn').classList.toggle('active');
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function toggleTextItalic() {
    slides[currentSlide].textItalic = !slides[currentSlide].textItalic;
    document.getElementById('textItalicBtn').classList.toggle('active');
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectVerticalAlignment(value) {
    const slide = slides[currentSlide];
    if (!slide.contentAlignment) {
        slide.contentAlignment = { vertical: 'middle' };
    }
    slide.contentAlignment.vertical = value;
    
    document.querySelectorAll('[data-target="vertical"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
    });
    
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectTitleAlignment(value) {
    const slide = slides[currentSlide];
    if (!slide.titleAlignment) {
        slide.titleAlignment = { horizontal: 'center' };
    }
    slide.titleAlignment.horizontal = value;
    
    document.querySelectorAll('[data-target="title"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
    });
    
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectTextAlignment(value) {
    const slide = slides[currentSlide];
    if (!slide.textAlignment) {
        slide.textAlignment = { horizontal: 'left' };
    }
    slide.textAlignment.horizontal = value;
    
    document.querySelectorAll('[data-target="text"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
    });
    
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function toggleShadow(checked) {
    slides[currentSlide].textShadow = checked;

    const sc = document.getElementById('shadowControls');
    const acc = document.getElementById('advancedTextContent');

    sc.classList.toggle('active', checked);

    requestAnimationFrame(() => {
        sc.style.maxHeight = checked ? sc.scrollHeight + 'px' : '0px';
        if (acc && acc.classList.contains('open')) {
            acc.style.maxHeight = acc.scrollHeight + 'px';
        }
    });

    renderSlide();
}

function updateShadowBlur(value) {
    slides[currentSlide].shadowBlur = parseInt(value);
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateShadowOffset(value) {
    slides[currentSlide].shadowOffset = parseInt(value);
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function updateShadowColor(value) {
    slides[currentSlide].shadowColor = value;
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function applyText() {
    const slide = slides[currentSlide];
    let fullText = document.getElementById('unifiedTextInput').value;
    const noTitle = document.getElementById('noTitleCheckbox').checked;
    
    slide.noTitle = noTitle;
    fullText = fullText.replace(/^\s*\n+/, '');
    
    if (noTitle || !fullText.trim()) {
        slide.title = '';
        slide.text = fullText.trim() || '';
    } else {
        const firstNewlineIndex = fullText.search(/\n/);
        
        if (firstNewlineIndex !== -1) {
            let title = fullText.substring(0, firstNewlineIndex).trim();
            if (title.length > 100) {
                title = title.substring(0, 100);
            }
            slide.title = title;
            slide.text = fullText.substring(firstNewlineIndex + 1).trim() || '';
        } else {
            const sentenceMatch = fullText.match(/^[^.!?]+[.!?]+/);
            
            if (sentenceMatch) {
                let title = sentenceMatch[0].trim();
                if (title.length > 100) {
                    title = title.substring(0, 100);
                }
                slide.title = title;
                slide.text = fullText.substring(sentenceMatch[0].length).trim() || '';
            } else {
                if (fullText.length > 100) {
                    slide.title = fullText.substring(0, 100).trim();
                    slide.text = fullText.substring(100).trim();
                } else {
                    slide.title = fullText.trim();
                    slide.text = '';
                }
            }
        }
    }
    
    const applyToAll = document.getElementById('applyTextToAll').checked;
    
    if (applyToAll) {
        const settings = {
            titleFont: slide.titleFont,
            textFont: slide.textFont,
            titleSize: slide.titleSize,
            textSize: slide.textSize,
            contentAlignment: { ...slide.contentAlignment },
            titleAlignment: { ...slide.titleAlignment },
            textAlignment: { ...slide.textAlignment },
            paddingTop: slide.paddingTop,
            paddingBottom: slide.paddingBottom,
            paddingLeft: slide.paddingLeft,
            paddingRight: slide.paddingRight,
            titleLineHeight: slide.titleLineHeight,
            textLineHeight: slide.textLineHeight,
            textShadow: slide.textShadow,
            shadowBlur: slide.shadowBlur,
            shadowOffset: slide.shadowOffset,
            shadowColor: slide.shadowColor,
            textColor: slide.textColor,
            titleColor: slide.titleColor
        };
        
        slides.forEach((s, index) => {
            if (index !== 0) {
                Object.assign(s, settings);
            }
        });
    }
    
    renderSlide();
    autoFitFontSize();
    closeModal('text');
    if (window.autosaveTouch) window.autosaveTouch();
}

function selectRatio(ratio, button) {
    currentRatio = ratio;
    
    document.querySelectorAll('.ratio-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    button.classList.add('selected');
    
    renderSlide();
    if (window.autosaveTouch) window.autosaveTouch();
}

function toggleDownloadMenu() {
    const menu = document.getElementById('downloadMenu');
    if (menu) menu.classList.toggle('active');
}
// === ГАЛЕРЕЯ ПРЕДПРОСМОТРА ===
async function openGallery() {
    document.getElementById('downloadMenu')?.classList.remove('active');
    
    const modal = document.getElementById('galleryModal');
    const container = document.getElementById('galleryContainer');
    
    if (!modal || !container) return;
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    container.innerHTML = '<div class="gallery-loading">Генерация картинок...</div>';
    
    try {
        const galleryItems = [];
        
        for (let i = 0; i < slides.length; i++) {
            const blob = await slideToImage(i);
            const url = URL.createObjectURL(blob);
            
            galleryItems.push({
                index: i,
                url: url,
                blob: blob
            });
        }
        
        renderGallery(galleryItems);
        
    } catch (error) {
        console.error('Ошибка при генерации галереи:', error);
        container.innerHTML = '<div class="gallery-loading" style="color: #ff3b30;">Ошибка при загрузке галереи</div>';
    }
}

function renderGallery(items) {
    const container = document.getElementById('galleryContainer');
    if (!container) return;
    
    container.innerHTML = items.map((item, idx) => `
        <div class="gallery-item">
            <div class="gallery-slide-number">
                <span>Слайд ${item.index + 1}</span>
                <span style="font-size: 12px; color: #8e8e8e; font-weight: 400;">${getExportDimensions().width}×${getExportDimensions().height}</span>
            </div>
            <div class="gallery-image-wrapper">
                <img 
                    src="${item.url}" 
                    alt="Слайд ${item.index + 1}" 
                    class="gallery-image"
                    data-index="${item.index}">
            </div>
            <div class="gallery-actions">
                <button class="gallery-download-btn" onclick="downloadGallerySlide(${item.index})">
                    ⬇️ Скачать слайд
                </button>
            </div>
        </div>
    `).join('');
}

async function downloadGallerySlide(index) {
    try {
        const blob = await slideToImage(index);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `slide-${index + 1}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Ошибка при скачивании слайда:', error);
        alert('Не удалось скачать слайд');
    }
}

function closeGallery() {
    const modal = document.getElementById('galleryModal');
    const container = document.getElementById('galleryContainer');
    
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    if (container) {
        const images = container.querySelectorAll('.gallery-image');
        images.forEach(img => {
            if (img.src.startsWith('blob:')) {
                URL.revokeObjectURL(img.src);
            }
        });
        container.innerHTML = '<div class="gallery-loading">Загрузка...</div>';
    }
}

document.addEventListener('click', function(event) {
    const modal = document.getElementById('galleryModal');
    if (modal && event.target === modal) {
        closeGallery();
    }
});

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('galleryModal');
        if (modal && modal.classList.contains('active')) {
            closeGallery();
        }
    }
});

function getExportDimensions() {
    const dimensions = {
        '4-5': { width: 1080, height: 1350 },
        '1-1': { width: 1080, height: 1080 },
        '9-16': { width: 1080, height: 1920 }
    };
    return dimensions[currentRatio] || dimensions['4-5'];
}

async function slideToImage(slideIndex) {
            // Ждём загрузки шрифтов
            await document.fonts.ready;
            
            return new Promise((resolve, reject) => {
                const slide = slides[slideIndex];
                const dims = getExportDimensions();

                const dpr = 1;

                // 1. Setup Canvas and Context
                const canvas = document.createElement('canvas');
                canvas.width = dims.width * dpr;
                canvas.height = dims.height * dpr;
                canvas.style.width = dims.width + 'px';
                canvas.style.height = dims.height + 'px';

                const ctx = canvas.getContext('2d', { 
                    alpha: true,
                    desynchronized: false,
                    willReadFrequently: false
                });
                
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0); 
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                // 2. Drawing Functions
                const drawSlideContent = () => {
                    // 1. Draw Pattern (Must be drawn before content and overlay)
                    if (slide.pattern !== null) {
                        drawPattern(ctx, dims.width, dims.height, slide);
                    }
                    // 2. Draw Overlay
                    if (slide.overlayEnabled) {
                        drawOverlay(ctx, dims.width, dims.height, slide);
                    }
                    // 3. Draw Text (Content)
                    drawText(ctx, dims.width, dims.height, slide); 
                    
                    // Resolve with the generated Blob
                    canvas.toBlob((blob) => resolve(blob), 'image/png', 1.0);
                };

                const paintBackground = () => {
                    ctx.fillStyle = slide.bgColor;
                    ctx.fillRect(0, 0, dims.width, dims.height);
                    drawSlideContent();
                };

                // 3. Handle Background Image Loading
                if (slide.bgImage) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        const imgRatio = img.width / img.height;
                        const canvasRatio = dims.width / dims.height;
                        
                        let drawWidth, drawHeight, offsetX, offsetY;
                        
                        // Logic for "object-fit: cover"
                        if (imgRatio > canvasRatio) {
                            // Image is wider than canvas ratio, fit by height
                            drawHeight = dims.height;
                            drawWidth = img.width * (dims.height / img.height);
                            offsetX = (dims.width - drawWidth) / 2;
                            offsetY = 0;
                        } else {
                            // Image is taller than canvas ratio, fit by width
                            drawWidth = dims.width;
                            drawHeight = img.height * (dims.width / img.width);
                            offsetX = 0;
                            offsetY = (dims.height - drawHeight) / 2;
                        }
                        
                        ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                        drawSlideContent();
                    };
                    
                    img.onerror = () => {
                        console.warn('Не удалось загрузить фоновое изображение, используем цвет');
                        paintBackground();
                    };
                    
                    img.src = slide.bgImage;
                } else {
                    // 4. Handle Background Color
                    paintBackground();
                }
            });
        }

function drawPattern(ctx, width, height, slide) {
    // Предполагается, что 'patterns' и 'getExportDimensions' доступны в скоупе
    const patternData = patterns[slide.pattern];
    if (!patternData || !patternData.type || !patternData.baseSize) return;

    // Получаем ширину экспорта для расчета масштабирования разрешения
    const { width: exportWidth } = getExportDimensions();
    const resolutionScaleFactor = exportWidth / 1080; 

    // 1. Расчет размера тайла (BaseSize * UserScale * ResolutionScaleFactor)
    const userScale = slide.patternScale || 1.0;
    const finalTileSize = patternData.baseSize * userScale * resolutionScaleFactor;

    // --- ИНТЕГРИРОВАННАЯ ЛОГИКА ЦВЕТА ---
    const baseHexColor = slide.textColor || '#000000'; // Цвет текста
    const alpha = slide.patternOpacity || 0.5; // Прозрачность

    let hex = baseHexColor.startsWith('#') ? baseHexColor.slice(1) : baseHexColor;
    let r = 0, g = 0, b = 0;

    // Конвертация HEX в RGB компоненты
    if (hex.length === 3) {
        r = parseInt(hex[0] + hex[0], 16);
        g = parseInt(hex[1] + hex[1], 16);
        b = parseInt(hex[2] + hex[2], 16);
    } else if (hex.length === 6) {
        r = parseInt(hex.substring(0, 2), 16);
        g = parseInt(hex.substring(2, 4), 16);
        b = parseInt(hex.substring(4, 6), 16);
    }

    // 2. Устанавливаем финальный цвет узора в формате RGBA
    // Это позволяет применить прозрачность (alpha) к любому HEX цвету.
    const finalRgba = `rgba(${r}, ${g}, ${b}, ${alpha})`; 
    // --- КОНЕЦ ЛОГИКИ ЦВЕТА ---

    // 3. Создаем офф-скрин холст для узора (тайла)
    const offscreenCanvas = document.createElement('canvas');
    
    // Размеры холста для узора
    offscreenCanvas.width = finalTileSize;
    offscreenCanvas.height = finalTileSize;
    
    const pCtx = offscreenCanvas.getContext('2d');
    pCtx.fillStyle = finalRgba; // Применяем цвет с прозрачностью

    // 4. Отрисовываем специфичный узор на офф-скрин холсте
    // Толщина линии также масштабируется в зависимости от разрешения
    const lineThickness = 2 * resolutionScaleFactor; 

    if (patternData.type === 'dot') {
        const radius = lineThickness / 2;
        pCtx.beginPath();
        pCtx.arc(finalTileSize / 2, finalTileSize / 2, radius, 0, Math.PI * 2);
        pCtx.fill();
    } else if (patternData.type === 'vertical-line') {
        // Вертикальная линия толщиной lineThickness
        pCtx.fillRect(0, 0, lineThickness, finalTileSize);
    } else if (patternData.type === 'horizontal-line') {
        // Горизонтальная линия толщиной lineThickness
        pCtx.fillRect(0, 0, finalTileSize, lineThickness);
    } else if (patternData.type === 'grid') {
        // Вертикальная линия
        pCtx.fillRect(0, 0, lineThickness, finalTileSize);
        // Горизонтальная линия
        pCtx.fillRect(0, 0, finalTileSize, lineThickness);
    }

    // 5. Создаем и применяем паттерн к основному холсту
    const pattern = ctx.createPattern(offscreenCanvas, 'repeat');
    ctx.fillStyle = pattern;
    ctx.fillRect(0, 0, width, height);
}

function drawText(ctx, width, height, slide) {
  const vertical = slide.contentAlignment?.vertical || 'middle';
  const titleHorizontal = slide.titleAlignment?.horizontal || 'center';
  const textHorizontal = slide.textAlignment?.horizontal || 'left';

 const minSidePaddingPx = width * 0.09; // 9% от ширины
const minVerticalPaddingPx = height * 0.10; // 10% от высоты

const paddingTop = Math.max(slide.paddingTop, minVerticalPaddingPx);
const paddingBottom = Math.max(slide.paddingBottom, minVerticalPaddingPx);
const paddingLeft = Math.max(slide.paddingLeft, minSidePaddingPx);
const paddingRight = Math.max(slide.paddingRight, minSidePaddingPx);

  const contentWidth = width - paddingLeft - paddingRight;
  const contentHeight = height - paddingTop - paddingBottom;

  let titleLines = [];
  let titleFontSize = 0;
  let titleLineHeight = 0;
  let titleBlockHeight = 0;
  const gapBetween = 53;

  const shouldShowTitle = !slide.noTitle && slide.title && slide.title.trim();
  
  if (shouldShowTitle) {
    titleFontSize = slide.titleSize;
    const titleLH = (typeof slide.titleLineHeight === 'number' && slide.titleLineHeight > 0) 
      ? slide.titleLineHeight 
      : 1.2;
    
    ctx.font = `${slide.titleItalic ? 'italic' : 'normal'} ${slide.titleBold ? 'bold' : 'normal'} ${titleFontSize}px '${slide.titleFont}', sans-serif`;
    titleLines = wrapText(ctx, slide.title, contentWidth);
    titleLineHeight = titleFontSize * titleLH;
    titleBlockHeight = titleLines.length * titleLineHeight;
  }

  let textLines = [];
  let textFontSize = 0;
  let textLineHeight = 0;
  let textBlockHeight = 0;

  if (slide.text && slide.text.trim()) {
    textFontSize = slide.textSize;
    const textLH = (typeof slide.textLineHeight === 'number' && slide.textLineHeight > 0)
      ? slide.textLineHeight
      : 1.5;
    
    ctx.font = `${slide.textItalic ? 'italic' : 'normal'} ${slide.textBold ? 'bold' : 'normal'} ${textFontSize}px '${slide.textFont}', sans-serif`;
    textLines = wrapText(ctx, slide.text, contentWidth);
    textLineHeight = textFontSize * textLH;
    textBlockHeight = textLines.length * textLineHeight;
  }

  const hasTitle = (titleLines.length > 0);
  const hasText = (textLines.length > 0);
  const totalBlockHeight = (hasTitle ? titleBlockHeight : 0)
                         + (hasTitle && hasText ? gapBetween : 0)
                         + (hasText ? textBlockHeight : 0);

  let startY;
  if (vertical === 'top') {
    startY = paddingTop;
  } else if (vertical === 'bottom') {
    startY = height - paddingBottom - totalBlockHeight;
  } else {
    startY = paddingTop + (contentHeight - totalBlockHeight) / 2;
  }

  ctx.textBaseline = 'top';
  let currentY = Math.round(startY);

  if (hasTitle) {
    if (slide.textShadow) {
      ctx.shadowColor = slide.shadowColor || '#000000';
      ctx.shadowBlur = slide.shadowBlur || 4;
      ctx.shadowOffsetX = slide.shadowOffset || 2;
      ctx.shadowOffsetY = slide.shadowOffset || 2;
    } else {
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }
    
    ctx.fillStyle = slide.titleColor || slide.textColor;
    ctx.font = `${slide.titleItalic ? 'italic' : 'normal'} ${slide.titleBold ? 'bold' : 'normal'} ${titleFontSize}px '${slide.titleFont}', sans-serif`;

    let titleX;
    if (titleHorizontal === 'left') {
      ctx.textAlign = 'left';
      titleX = paddingLeft;
    } else if (titleHorizontal === 'right') {
      ctx.textAlign = 'right';
      titleX = width - paddingRight;
    } else {
      ctx.textAlign = 'center';
      titleX = width / 2;
    }

    for (const line of titleLines) {
      if (line !== '') {
        ctx.fillText(line, titleX, currentY);
      }
      currentY += titleLineHeight;
    }
  }

  if (hasTitle && hasText) {
    currentY += gapBetween;
  }

  if (hasText) {
    if (slide.textShadow) {
      ctx.shadowColor = slide.shadowColor || '#000000';
      ctx.shadowBlur = slide.shadowBlur || 4;
      ctx.shadowOffsetX = slide.shadowOffset || 2;
      ctx.shadowOffsetY = slide.shadowOffset || 2;
    } else {
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }
    
    ctx.fillStyle = slide.textColor;
    ctx.font = `${slide.textItalic ? 'italic' : 'normal'} ${slide.textBold ? 'bold' : 'normal'} ${textFontSize}px '${slide.textFont}', sans-serif`;

    let textX;
    if (textHorizontal === 'left') {
      ctx.textAlign = 'left';
      textX = paddingLeft;
    } else if (textHorizontal === 'right') {
      ctx.textAlign = 'right';
      textX = width - paddingRight;
    } else {
      ctx.textAlign = 'center';
      textX = width / 2;
    }

    for (const line of textLines) {
      if (line !== '') {
        ctx.fillText(line, textX, currentY);
      }
      currentY += textLineHeight;
    }
  }

  ctx.shadowColor = 'transparent';
  ctx.shadowBlur = 0;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 0;
}

function renderSlide() {
    const slide = slides[currentSlide];
    const canvas = document.getElementById('slideCanvas');
    const scale = canvas.offsetWidth / 1080;
    const bg = document.getElementById('slideBackground');
    const pattern = document.getElementById('slidePattern');
    const overlay = document.getElementById('slideOverlay');
    const content = document.querySelector('.slide-content');
    const title = document.getElementById('slideTitle');
    const text = document.getElementById('slideText');

    canvas.className = `slide-canvas ratio-${currentRatio}`;
    
    if (slide.bgImage) {
        bg.style.backgroundImage = `url(${slide.bgImage})`;
        bg.style.backgroundColor = '';
    } else {
        bg.style.backgroundImage = '';
        bg.style.backgroundColor = slide.bgColor;
    }

if (slide.pattern !== null) {
                const patternData = patterns[slide.pattern];
                
                if (patternData && patternData.css && patternData.baseSize) {
                    pattern.style.backgroundImage = patternData.css;
                    pattern.style.color = slide.textColor;
                    pattern.style.opacity = slide.patternOpacity;
                    
                    // Расчет размера тайла с учетом пользовательского масштаба и масштаба DOM-превью
                    const finalSize = patternData.baseSize * slide.patternScale * scale; 
                    
                    if (patternData.type === 'vertical-line') {
                        pattern.style.backgroundSize = `${finalSize}px 100%`;
                    } else if (patternData.type === 'horizontal-line') {
                        pattern.style.backgroundSize = `100% ${finalSize}px`;
                    } else {
                        pattern.style.backgroundSize = `${finalSize}px ${finalSize}px`;
                    }
                    
                    pattern.style.display = 'block';
                } else {
                    pattern.style.display = 'none';
                }
            } else {
                pattern.style.display = 'none';
            }

    if (slide.overlayEnabled) {
        overlay.style.display = 'block';
        overlay.style.height = `${slide.overlayHeight}%`;
        overlay.style.backgroundColor = slide.overlayColor;
        overlay.style.opacity = slide.overlayOpacity;
    } else {
        overlay.style.display = 'none';
    }

    const vertical = slide.contentAlignment?.vertical || 'middle';
    content.style.justifyContent = {
        'top': 'flex-start',
        'middle': 'center',
        'bottom': 'flex-end'
    }[vertical] || 'center';

   const minSidePadding = canvas.offsetWidth * 0.09; // 9% от ширины
const minVerticalPadding = canvas.offsetHeight * 0.10; // 10% от высоты

content.style.paddingTop = Math.max(slide.paddingTop * scale, minVerticalPadding) + 'px';
content.style.paddingBottom = Math.max(slide.paddingBottom * scale, minVerticalPadding) + 'px';
content.style.paddingLeft = Math.max(slide.paddingLeft * scale, minSidePadding) + 'px';
content.style.paddingRight = Math.max(slide.paddingRight * scale, minSidePadding) + 'px';

    const shouldShowTitle = !slide.noTitle && slide.title && slide.title.trim();
    const titleHorizontal = slide.titleAlignment?.horizontal || 'center';
    
    if (shouldShowTitle) {
        title.style.display = 'block';
        title.textContent = slide.title;
title.style.fontSize = `${slide.titleSize * scale}px`; // С scale
    title.style.color = slide.titleColor || '#000000';

        title.style.color = slide.titleColor || '#000000';
        title.style.fontFamily = `'${slide.titleFont}', sans-serif`;
        title.style.fontWeight = slide.titleBold ? '700' : '400';
        title.style.fontStyle = slide.titleItalic ? 'italic' : 'normal';
        title.style.lineHeight = slide.titleLineHeight;
        title.style.whiteSpace = 'pre-wrap';
        title.style.textAlign = titleHorizontal;
        title.style.marginBottom = `${53 * scale}px`; // Добавь эту строку
        
    } else {
        title.style.display = 'none';
         title.style.marginBottom = '0px'; 
    }

  const textHorizontal = slide.textAlignment?.horizontal || 'left';
if (slide.text && slide.text.trim()) {
    text.style.display = 'block';
    text.textContent = slide.text;
    text.style.fontSize = `${slide.textSize * scale}px`;
    text.style.color = slide.textColor;
    text.style.fontFamily = `'${slide.textFont}', sans-serif`;
    text.style.fontWeight = slide.textBold ? '700' : '400';
    text.style.fontStyle = slide.textItalic ? 'italic' : 'normal';
    text.style.lineHeight = slide.textLineHeight;
    text.style.whiteSpace = 'pre-wrap';
    text.style.textAlign = textHorizontal;
} else {
    text.style.display = 'none';
}

    if (slide.textShadow) {
    const shadow = `${slide.shadowOffset * scale}px ${slide.shadowOffset * scale}px ${slide.shadowBlur * scale}px ${slide.shadowColor}`;
    if (shouldShowTitle) title.style.textShadow = shadow;
    text.style.textShadow = shadow;
} else {
    title.style.textShadow = 'none';
    text.style.textShadow = 'none';
}
}

function wrapText(ctx, text, maxWidth) {
    const normalizedText = text;
    const paragraphs = normalizedText.split('\n');
    const lines = [];
    
    paragraphs.forEach((paragraph, pIndex) => {
        if (paragraph.trim() === '') {
            lines.push('');
            return;
        }
        
        const words = paragraph.split(' ');
        let currentLine = '';
        
        words.forEach(word => {
            const testLine = currentLine + (currentLine ? ' ' : '') + word;
            const metrics = ctx.measureText(testLine);
            
            if (metrics.width > maxWidth && currentLine) {
                // Строка не влезает, переносим
                lines.push(currentLine);
                
                // Проверяем, влезает ли само слово
                const wordMetrics = ctx.measureText(word);
                
                if (wordMetrics.width > maxWidth) {
                    // Слово не влезает целиком
                    if (word.includes('-')) {
                        // Есть дефис → разбиваем по дефису
                        const parts = word.split('-');
                        currentLine = '';
                        
                        parts.forEach((part, i) => {
                            const isLast = i === parts.length - 1;
                            const withDash = isLast ? part : part + '-';
                            const testPart = currentLine + withDash;
                            
                            if (ctx.measureText(testPart).width > maxWidth && currentLine) {
                                lines.push(currentLine);
                                currentLine = withDash;
                            } else {
                                currentLine = testPart;
                            }
                        });
                    } else {
                        // Нет дефиса → принудительный разрыв по символам
                        currentLine = '';
                        for (let i = 0; i < word.length; i++) {
                            const char = word[i];
                            const testChar = currentLine + char;
                            
                            if (ctx.measureText(testChar).width > maxWidth && currentLine) {
                                lines.push(currentLine);
                                currentLine = char;
                            } else {
                                currentLine = testChar;
                            }
                        }
                    }
                } else {
                    // Слово влезает → переносим целиком
                    currentLine = word;
                }
            } else {
                currentLine = testLine;
            }
        });
        
        if (currentLine) {
            lines.push(currentLine);
        }
    });
    
    return lines;
}

let isExporting = false;
const MAX_SHARE_FILES = 12;
const MAX_SHARE_MB = 50;
const MAX_ONE_FILE_MB = 12;

const toMB = b => (b || 0) / 1024 / 1024;

async function slideBlob(i) {
  const res = await slideToImage(i);
  if (res instanceof Blob) return res;
  if (res && typeof res.toBlob === 'function') {
    return await new Promise(r => res.toBlob(r, 'image/png', 0.92));
  }
  throw new Error('slideToImage(i) должен вернуть Blob или Canvas');
}

async function filesForIndices(indices) {
  const files = [];
  for (const i of indices) {
    const blob = await slideBlob(i);
    if (toMB(blob.size) > MAX_ONE_FILE_MB) {
      console.warn('One file too large:', toMB(blob.size).toFixed(2), 'MB');
      return null;
    }
    files.push(new File([blob], `slide-${i + 1}.png`, { type: 'image/png' }));
  }
  return files;
}

function chunkForShare(files) {
  const chunks = [];
  let cur = [], sz = 0;
  for (const f of files) {
    const fmb = toMB(f.size);
    const overCount = cur.length + 1 > MAX_SHARE_FILES;
    const overSize = sz + fmb > MAX_SHARE_MB;
    if (overCount || overSize) {
      if (cur.length) chunks.push(cur);
      cur = [f]; sz = fmb;
    } else {
      cur.push(f); sz += fmb;
    }
  }
  if (cur.length) chunks.push(cur);
  return chunks;
}

async function zipAndDownload(files, name = 'slides.zip') {
  const zip = new JSZip();
  files.forEach(f => zip.file(f.name, f));
  const blob = await zip.generateAsync({ type: 'blob' });
  saveAs(blob, name);
}

function shareSupportedWithFiles(files) {
  if (!files || !Array.isArray(files) || files.length === 0) {
    return false;
  }
  if (!navigator.canShare || !navigator.share) {
    return false;
  }
  try {
    return navigator.canShare({ files: [files[0]] });
  } catch (e) {
    console.warn('canShare check failed:', e);
    return false;
  }
}

async function downloadCurrentSlide() {
  if (isExporting) return;
  isExporting = true;

  document.getElementById('downloadMenu')?.classList.remove('active');

  try {
    const fileArr = await filesForIndices([currentSlide]);
    if (!fileArr) {
      const blob = await slideBlob(currentSlide);
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {
        href: url, download: `slide-${currentSlide + 1}.png`
      });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      return;
    }

    if (shareSupportedWithFiles(fileArr)) {
      try {
        await navigator.share({ files: fileArr, title: `Слайд ${currentSlide + 1}` });
        return;
      } catch (e) {
        console.warn('Share rejected:', e?.name || e);
      }
    }

    const blob = await slideBlob(currentSlide);
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {
      href: url, download: `slide-${currentSlide + 1}.png`
    });
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);

  } catch (e) {
    console.error('Ошибка при экспорте слайда:', e);
    alert('Не удалось экспортировать слайд.');
  } finally {
    isExporting = false;
  }
}

async function downloadAllSlides() {
  if (isExporting) return;
  isExporting = true;

  document.getElementById('downloadMenu')?.classList.remove('active');

  try {
    const indices = Array.from({ length: slides.length }, (_, i) => i);
    const files = await filesForIndices(indices);

    if (!files) {
      console.warn('Share too large → ZIP fallback');
      await zipAndDownload(await filesForIndices(indices) ?? [], 'slides.zip');
      return;
    }

    if (shareSupportedWithFiles(files)) {
      const chunks = chunkForShare(files);
      let sharedAny = false;
      for (const batch of chunks) {
        if (!navigator.canShare({ files: batch })) {
          console.warn('Batch canShare=false, zip fallback');
          sharedAny = false;
          break;
        }
        try {
          await navigator.share({ files: batch, title: 'Карусель', text: 'Слайды' });
          sharedAny = true;
        } catch (e) {
          console.warn('Batch share rejected:', e?.name || e);
          sharedAny = false;
          break;
        }
      }
      if (sharedAny) return;
      console.warn('Share failed mid-way → ZIP fallback');
    } else {
      console.warn('navigator.share not supported for files → ZIP fallback');
    }

    await zipAndDownload(files, 'slides.zip');

  } catch (e) {
    console.error('Ошибка при экспорте слайдов:', e);
    alert('Не удалось экспортировать слайды.');
  } finally {
    isExporting = false;
  }
}

function importFromText() {
    const text = document.getElementById('importTextArea').value.trim();
    
    if (!text) {
        alert('Пожалуйста, вставьте текст для импорта');
        return;
    }
    
    const parsedSlides = parseImportText(text);
    
    if (parsedSlides.error) {
        alert(parsedSlides.error);
        return;
    }
    
    if (parsedSlides.slides.length === 0) {
        alert('Не найдено маркеров слайдов. Напишите в службу заботы или главный канал MIX');
        return;
    }
    
    if (parsedSlides.slides.length > 15) {
        alert(`Максимум 15 слайдов, а у вас ${parsedSlides.slides.length}. Пожалуйста, сократите количество слайдов.`);
        return;
    }
    
    importSlides(parsedSlides.slides);
    closeWelcomeModal();
    currentSlide = 0;
    renderSlide();
    updateNavigation();
}

function parseImportText(text) {
    const slideRegex = /(?:^|\n)(слайд\s+\d+(?:\s*\(обложка\))?)/gi;
    
    const matches = [];
    let match;
    
    while ((match = slideRegex.exec(text)) !== null) {
        matches.push({
            index: match.index + match[0].indexOf(match[1]),
            marker: match[1]
        });
    }
    
    if (matches.length === 0) {
        return { error: 'Не найдено маркеров слайдов', slides: [] };
    }
    
    const parsedSlides = [];
    
    for (let i = 0; i < matches.length; i++) {
        const currentMatch = matches[i];
        const nextMatch = matches[i + 1];
        
        const startIndex = currentMatch.index + currentMatch.marker.length;
        const endIndex = nextMatch ? nextMatch.index : text.length;
        let slideText = text.substring(startIndex, endIndex).trim();
        
        slideText = slideText.replace(/^\s*\n+/, '');
        
        if (!slideText) {
            continue;
        }
        
        let title = '';
        let bodyText = '';
        
        const lines = slideText.split('\n');
        
        if (lines.length > 0) {
            title = lines[0].trim();
            
            if (lines.length > 1) {
                bodyText = lines.slice(1).join('\n').trim();
            }
        }
        
        const isFirstSlide = i === 0;
        
        const newSlide = {
            title: title || 'Заголовок слайда',
            text: bodyText || '',
            titleSize: 106,
            textSize: 53,
            bgColor: '#ffffff',
            bgImage: null,
            textColor: '#000000',
            titleColor: '#000000',
            pattern: null,
            patternOpacity: 0.3,
            patternScale: 66,
            isTitle: isFirstSlide,
            noTitle: false,
            titleFont: 'Montserrat',
            textFont: 'Roboto',
            titleBold: true,
            titleItalic: false,
            textBold: false,
            textItalic: false,
            contentAlignment: { vertical: 'middle' },
            titleAlignment: { horizontal: 'center' },
            textAlignment: { horizontal: 'left' },
            paddingTop: 30,
            paddingBottom: 30,
            paddingLeft: 30,
            paddingRight: 30,
            titleLineHeight: 1.2,
            textLineHeight: 1.5,
            textShadow: false,
            shadowBlur: 4,
            shadowOffset: 2,
            shadowColor: '#000000',
            overlayEnabled: false,
            overlayColor: '#000000',
            overlayOpacity: 0.8,
            overlayHeight: 60
        };

        parsedSlides.push(newSlide);
    }
    
    return { slides: parsedSlides };
}

function importSlides(newSlides) {
    slides = newSlides;
    currentSlide = 0;
    renderSlide();
    updateNavigation();
    updateDeleteButton();
}

init();

document.addEventListener('click', function(event) {
    const menu = document.getElementById('downloadMenu');
    const downloadBtn = document.querySelector('.btn-download');
    
    if (menu && !menu.contains(event.target) && !downloadBtn.contains(event.target)) {
        menu.classList.remove('active');
    }
});
</script>
